<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <title>TurboHaskell Guide</title>

    <link rel="stylesheet" href="https://unpkg.com/spectre.css/dist/spectre.min.css">
  </head>
  <body style="max-width: 800px; margin-left: auto; margin-right: auto; margin-top: 3rem">


    <div class="container mt-5"><h1 id="getting-started-with-turbo-haskell">Getting Started With Turbo Haskell</h1>
<p>Turbo Haskell is a full stack framework focused on rapid application development while striving for robust code quality.</p>
<p>This guide covers everything you need to ship software with interactive lambda.</p>
<h5 id="feature-overview">Feature Overview</h5>
<ul>
<li>
<strong>Fully managed dev environment:</strong> Works on any machine because all dependencies (including PostgreSQL) are managed using the nix package manager.
</li>
<li>
<strong>Bootstrap 4 Out of the box:</strong> The default layout already integrates bootstrap 4.
</li>
<li>
<strong>Auto live reload using virtual dom in dev mode:</strong> Each code change changes your local page to refresh. The refresh uses a diff based patch to avoid resetting the page state.
</li>
<li>
<strong>Build robust applications:</strong> With the power of haskell your application are going to be a lot more robust. Pretty much no runtime errors in production.
</li>
<li>
<strong>Fast dev enviroment:</strong> While we use a compiled language, the built-in dev server automatically reloads your code changes using the fastest way possible. Usually changes are reflected in less than 100ms (alot faster than your average webpack setup).
</li>
<li>
<strong>Very fast production environment:</strong> Production response times around 30ms. Using <a href="http://instantclick.io/">instant click</a> it can be faster than your average SPA.
</li>
</ul>
<ul>
<li>
<a href="#getting-started-with-turbo-haskell">Getting Started With Turbo Haskell</a>
<ul>
<li>
<a href="#feature-overview">Feature Overview</a>
</li>
<li>
<a href="#dependencies">Dependencies</a>
<ul>
<li>
<a href="#1-nix-package-manager">1. Nix Package Manager</a>
<ul>
<li>
<a href="#macos-linux">MacOS, Linux</a>
</li>
<li>
<a href="#windows">Windows</a>
</li>
</ul>
</li>
<li>
<a href="#2-direnv">2. Direnv</a>
<ul>
<li>
<a href="#bash">Bash</a>
</li>
<li>
<a href="#zsh">ZSH</a>
</li>
<li>
<a href="#other-shell">Other shell</a>
</li>
</ul>
</li>
<li>
<a href="#2-installing-turbohaskell">2. Installing TurboHaskell</a>
</li>
</ul>
</li>
</ul>
</li>
<li>
<a href="#creating-your-first-project">Creating Your First Project</a>
<ul>
<li>
<a href="#1-project-setup">1. Project Setup</a>
</li>
<li>
<a href="#2-hello-world">2. Hello, World!</a>
</li>
<li>
<a href="#3-data-structures-postgresql">3. Data Structures &amp; PostgreSQL</a>
<ul>
<li>
<a href="#schema-modeling">Schema Modeling</a>
</li>
<li>
<a href="#loading-the-schema">Loading the Schema</a>
</li>
<li>
<a href="#record-types">Record Types</a>
</li>
</ul>
</li>
<li>
<a href="#4-apps-controllers-views">4. Apps, Controllers, Views</a>
<ul>
<li>
<a href="#new-types">New Types</a>
</li>
<li>
<a href="#controller-implementation-webcontrollerpostshs">Controller Implementation: <code>Web/Controller/Posts.hs</code></a>
<ul>
<li>
<a href="#imports">Imports</a>
</li>
<li>
<a href="#instance">Instance</a>
</li>
<li>
<a href="#index-action">Index Action</a>
</li>
<li>
<a href="#new-action">New Action</a>
</li>
<li>
<a href="#show-action">Show Action</a>
</li>
<li>
<a href="#edit-action">Edit Action</a>
</li>
<li>
<a href="#update-action">Update Action</a>
</li>
</ul>
</li>
<li>
<a href="#routes">Routes</a>
</li>
<li>
<a href="#views">Views</a>
</li>
</ul>
</li>
<li>
<a href="#5-extending-the-blog">5. Extending the Blog</a>
<ul>
<li>
<a href="#creating-a-post">Creating a Post</a>
</li>
<li>
<a href="#displaying-a-post">Displaying a Post</a>
</li>
<li>
<a href="#display-all-posts">Display all posts</a>
</li>
<li>
<a href="#adding-validation">Adding Validation</a>
</li>
<li>
<a href="#timestamps">Timestamps</a>
</li>
<li>
<a href="#markdown">Markdown</a>
<ul>
<li>
<a href="#adding-a-markdown-library">Adding a Markdown Library</a>
</li>
<li>
<a href="#markdown-rendering">Markdown Rendering</a>
</li>
<li>
<a href="#forms-validation">Forms &amp; Validation</a>
</li>
</ul>
</li>
</ul>
</li>
<li>
<a href="#6-a-second-model">6. A Second Model</a>
<ul>
<li>
<a href="#61-schema-modeling">6.1 Schema Modeling</a>
</li>
<li>
<a href="#62-loading-the-schema">6.2 Loading the Schema</a>
</li>
<li>
<a href="#63-the-controller">6.3 The Controller</a>
</li>
</ul>
</li>
<li>
<a href="#form-customization">Form Customization</a>
</li>
<li>
<a href="#login-logout">Login &amp; Logout</a>
</li>
</ul>
</li>
<li>
<a href="#querybuilder-reference">QueryBuilder Reference</a>
<ul>
<li>
<a href="#creating-a-new-query">Creating a new query</a>
</li>
<li>
<a href="#running-a-query">Running a query</a>
<ul>
<li>
<a href="#many-rows-fetch">many rows: <code>fetch</code></a>
</li>
<li>
<a href="#maybe-single-row-fetchoneornothing">maybe single row: <code>fetchOneOrNothing</code></a>
</li>
<li>
<a href="#single-row-fetchone">single row: <code>fetchOne</code></a>
</li>
</ul>
</li>
<li>
<a href="#where-conditions">Where Conditions</a>
</li>
<li>
<a href="#order-by">Order By</a>
</li>
<li>
<a href="#or">Or</a>
</li>
<li>
<a href="#union-merging-two-queries">Union / Merging two queries</a>
</li>
<li>
<a href="#shortcuts">Shortcuts</a>
<ul>
<li>
<a href="#findby-field-value"><code>findBy #field value</code></a>
</li>
<li>
<a href="#findmaybeby-field-value"><code>findMaybeBy #field value</code></a>
</li>
<li>
<a href="#findbyid-id"><code>findById id</code></a>
</li>
<li>
<a href="#findmanyby-field-value"><code>findManyBy #field value</code></a>
</li>
</ul>
</li>
<li>
<a href="#projectid-fetch"><code>projectId |&gt; fetch</code></a>
</li>
<li>
<a href="#raw-sql-queries">Raw SQL Queries</a>
</li>
</ul>
</li>
<li>
<a href="#validation-reference">Validation Reference</a>
<ul>
<li>
<a href="#pure-validations">Pure Validations</a>
<ul>
<li>
<a href="#custom-validators">Custom Validators</a>
</li>
</ul>
</li>
<li>
<a href="#uniqueness">Uniqueness</a>
</li>
<li>
<a href="#validate-permissions">Validate Permissions</a>
</li>
</ul>
</li>
<li>
<a href="#view-helper-reference">View Helper Reference</a>
<ul>
<li>
<a href="#time">Time</a>
<ul>
<li>
<a href="#timeago"><code>timeAgo</code></a>
</li>
<li>
<a href="#datetime"><code>dateTime</code></a>
</li>
</ul>
</li>
</ul>
</li>
<li>
<a href="#command-line-reference">Command Line Reference</a>
</li>
<li>
<a href="#form-reference">Form Reference</a>
<ul>
<li>
<a href="#select-inputs">Select Inputs</a>
</li>
</ul>
</li>
<li>
<a href="#debuging">Debuging</a>
</li>
<li>
<a href="#architecture">Architecture</a>
<ul>
<li>
<a href="#where-to-place-a-function-i-want-to-use-in-all-my-views">Where to place a function I want to use in all my views?</a>
</li>
<li>
<a href="#where-to-place-a-function-i-want-to-use-in-all-my-controllers">Where to place a function I want to use in all my controllers?</a>
</li>
<li>
<a href="#where-to-place-a-custom-type">Where to place a custom type?</a>
</li>
<li>
<a href="#next-to-my-main-web-application-im-building-an-admin-backend-application-where-to-place-it">Next to my main web application, I’m building an admin backend application. Where to place it?</a>
</li>
</ul>
</li>
</ul>
<h2 id="dependencies">Dependencies</h2>
<h3 id="1-nix-package-manager">1. Nix Package Manager</h3>
<p>The framework uses the nix package manager to manage the whole set of dependencies of your application</p>
<p>For example postgresql and the haskell compiler are both dependencies of your app. as well as all the haskell or javascript packages you want to use. we use nix to make sure that these dependencies are available to the app - in development, as well as in production.</p>
<p>That’s why we first need to make sure that you have nix installed.</p>
<h5 id="macos-linux">MacOS, Linux</h5>
<p>Install nix by running the following command in your shell and follow the instructions on the screen:</p>
<div class="source-code"><pre><code class="language-bash"><span class="ex">curl</span><span> https://nixos.org/nix/install </span><span class="kw">|</span><span> </span><span class="fu">sh</span>
</code></pre></div>
<p>There are also other ways to install nix, <a href="https://nixos.org/nix/download.html">take a look at the documentation</a>.</p>
<h5 id="windows">Windows</h5>
<p>Sorry, we don’t support windows yet.</p>
<h3 id="2-direnv">2. Direnv</h3>
<p>TurboHaskell uses <code>direnv</code> to speed up the development shell. As it needs to be hooked into your shell, it needs to be installed manually.</p>
<p>Install it via nix:</p>
<div class="source-code"><pre><code class="language-bash"><span class="ex">nix-env</span><span> -i direnv</span>
</code></pre></div>
<p><strong>After that you also need to hook it into your shell:</strong></p>
<h5 id="bash">Bash</h5>
<p>If you use bash, add the following line at the end of the <code>~/.bashrc</code> file:</p>
<div class="source-code"><pre><code class="language-bash"><span class="bu">eval</span><span> </span><span class="st">&quot;</span><span class="va">$(</span><span class="ex">direnv</span><span> hook bash</span><span class="va">)</span><span class="st">&quot;</span>
</code></pre></div>
<h5 id="zsh">ZSH</h5>
<p>If you use zsh, add the following line at the end of the <code>~/.zshrc</code> file:</p>
<div class="source-code"><pre><code class="language-bash"><span class="bu">eval</span><span> </span><span class="st">&quot;</span><span class="va">$(</span><span class="ex">direnv</span><span> hook zsh</span><span class="va">)</span><span class="st">&quot;</span>
</code></pre></div>
<h5 id="other-shell">Other shell</h5>
<p>For other shells, <a href="https://direnv.net/#README">take a look at the direnv documentation</a>.</p>
<h3 id="2-installing-turbohaskell">2. Installing TurboHaskell</h3>
<p>You can now install interactive lambda by running:</p>
<div class="source-code"><pre><code class="language-bash"><span>$ </span><span class="ex">nix-env</span><span> -f https://turbohaskell.digitallyinduced.com/turbohaskell-new.tar.gz -i turbohaskell-new</span>
</code></pre></div>
<h1 id="creating-your-first-project">Creating Your First Project</h1>
<h3 id="1-project-setup">1. Project Setup</h3>
<p>This guide will lead you to create a small blog application. To set up the project, open a terminal and type:</p>
<div class="source-code"><pre><code class="language-bash"><span>$ </span><span class="ex">turbohaskell-new</span><span> blog</span>
</code></pre></div>
<p>The new <code>blog</code> directory now contains a couple of auto-generated files and directories that make up your app.</p>
<p>Here is a short overview of the whole structure:</p>
<table>
<thead>
<tr><th>File or Directory</th><th>Purpose</th></tr>
</thead>
<tbody>
<tr><td>Config/</td><td></td></tr>
<tr><td>Config/Config.hs</td><td>Configuration for the framework and your application</td></tr>
<tr><td>Config/nix/nixpkgs-config.nix</td><td>Configuration for the nix package manager</td></tr>
<tr><td>Config/nix/haskell-packages/</td><td>Custom haskell dependencies can be placed here</td></tr>
<tr><td>Application/</td><td>Your domain logic lives here</td></tr>
<tr><td>Application/Schema.hs</td><td>Models and database tables are defined here</td></tr>
<tr><td>Web/Controller</td><td>Web application controllers</td></tr>
<tr><td>Web/View/</td><td>Web application html template files</td></tr>
<tr><td>Web/Types.hs</td><td>Central place for all web application types</td></tr>
<tr><td>static/</td><td>Images, css and javascript files</td></tr>
<tr><td>.ghci</td><td>Default config file for the haskell interpreter</td></tr>
<tr><td>.gitignore</td><td>List of files to be ignored by git</td></tr>
<tr><td>App.cabal, Setup.hs</td><td>Config for the cabal package manager (TODO: maybe move to Config/App.cabal)</td></tr>
<tr><td>default.nix</td><td>Declares your app dependencies (like package.json or composer.json)</td></tr>
<tr><td>Makefile</td><td>Default config file for the make build system</td></tr>
</tbody>
</table>
<h3 id="2-hello-world">2. Hello, World!</h3>
<p>You now already have a working haskell app ready to be started.
You can start the development server by running this in the <code>Blog</code> directory:</p>
<div class="source-code"><pre><code class="language-bash"><span>$ </span><span class="fu">make</span>
</code></pre></div>
<p>Your app is now running at <a href="http://localhost:8000/">http://localhost:8000</a>.
The server can be stopped by pressing CTRL+C.</p>
<p>The built-in development server automatically starts a PostgreSQL database connected to your application. So you don’t need to worry about manually setting up the database.</p>
<h3 id="3-data-structures-postgresql">3. Data Structures &amp; PostgreSQL</h3>
<h5 id="schema-modeling">Schema Modeling</h5>
<p>For our blog we’re going to deal with posts. A post has a title and a body and of course also an id. TurboHaskell is using UUIDs instead of the typical numerics ids.</p>
<p><strong>A <code>posts</code> table in a PostgreSQL database could loke like this:</strong></p>
<table>
<thead>
<tr><th>id :: UUID</th><th>title :: Text</th><th>body :: Text</th></tr>
</thead>
<tbody>
<tr><td>8d040c2d-0199-4695-ac13-c301970cff1d</td><td>My Experience With Nix On OS X</td><td>Some time ago, I’ve moved this jekyll-based blog …</td></tr>
<tr><td>b739bc7c-5ed1-43f4-944c-385aea80f182</td><td>Deploying Private GitHub Repositories To NixOS Servers</td><td>In a previous post I’ve already shared a way to deploy private git repositories to a NixOS based server. While …</td></tr>
</tbody>
</table>
<p>To work with posts in our application, we now have to declare this data schema.
Open <code>Application/Schema.hs</code> and add the following code:</p>
<div class="source-code"><pre><code class="language-haskell"><span class="kw">module</span><span> </span><span class="cr">Application.Schema</span><span> </span><span class="kw">where</span><span>
</span><span class="kw">import</span><span> </span><span class="cr">ClassyPrelude</span><span> </span><span class="sy">(</span><span class="cr">Maybe</span><span> </span><span class="sy">(</span><span class="sy">..</span><span class="sy">)</span><span class="sy">,</span><span> </span><span class="sy">(</span><span class="op">&lt;&gt;</span><span class="sy">)</span><span class="sy">,</span><span> </span><span class="cr">Bool</span><span> </span><span class="sy">(</span><span class="sy">..</span><span class="sy">)</span><span class="sy">)</span><span>
</span><span class="kw">import</span><span> </span><span class="cr">TurboHaskell.SchemaSupport</span><span>

</span><span class="va">database</span><span> </span><span class="sy">=</span><span> </span><span class="sy">[</span><span>
    </span><span class="va">table</span><span> </span><span class="st">&quot;posts&quot;</span><span>
        </span><span class="op">+</span><span> </span><span class="va">field</span><span> </span><span class="st">&quot;id&quot;</span><span> </span><span class="va">primaryKey</span><span>
        </span><span class="op">+</span><span> </span><span class="va">field</span><span> </span><span class="st">&quot;title&quot;</span><span> </span><span class="va">text</span><span>
        </span><span class="op">+</span><span> </span><span class="va">field</span><span> </span><span class="st">&quot;body&quot;</span><span> </span><span class="va">text</span><span>
    </span><span class="sy">]</span><span>
</span></code></pre></div>
<h5 id="loading-the-schema">Loading the Schema</h5>
<p>Next we need to create the <code>posts</code> table in our local postgresql database.
Don’t worry, the local development postgresql server is already running. The dev server has conveniently already started it.</p>
<p>Take a look at <code>Application/Schema.sql</code>. The dev server has auto-generated a <code>CREATE TABLE</code>-statement for us:</p>
<div class="source-code"><pre><code class="language-sql"><span class="kw">CREATE</span><span> EXTENSION </span><span class="cf">IF</span><span> </span><span class="kw">NOT</span><span> </span><span class="kw">EXISTS</span><span> </span><span class="ot">&quot;uuid-ossp&quot;</span><span>;</span>

<span class="co">-- Please don&#39;t make any modifications to this file as it&#39;s auto generated. Use Application/Schema.hs to change the schema</span>
<span class="kw">CREATE</span><span> </span><span class="kw">TABLE</span><span> posts (</span>
<span>    </span><span class="kw">id</span><span> UUID </span><span class="kw">DEFAULT</span><span> uuid_generate_v4() </span><span class="kw">PRIMARY</span><span> </span><span class="kw">KEY</span><span> </span><span class="kw">NOT</span><span> </span><span class="kw">NULL</span><span>,</span>
<span>    title TEXT </span><span class="kw">NOT</span><span> </span><span class="kw">NULL</span><span>,</span>
<span>    </span><span class="kw">body</span><span> TEXT </span><span class="kw">NOT</span><span> </span><span class="kw">NULL</span>
<span>);</span>
</code></pre></div>
<p>We just need to load this sql statement into our database. Open your terminal and run:</p>
<div class="source-code"><pre><code class="language-bash"><span>$ </span><span class="fu">make</span><span> db</span>
</code></pre></div>
<p>The <code>posts</code> table has been created now. Let’s quickly connect to our database and see that everything is correct:</p>
<div class="source-code"><pre><code class="language-bash"><span>$ </span><span class="fu">make</span><span> psql</span>

<span class="ex">psql</span><span> (9.6.12)</span>
<span class="ex">Type</span><span> </span><span class="st">&quot;help&quot;</span><span> for help.</span>

<span class="ex">--</span><span> Let</span><span class="st">&#39;s do a query to check that the table is there</span>

<span class="st">app=# select * from posts;</span>

<span class="st"> id | title | body</span>
<span class="st">----+-------+------</span>
<span class="st">(0 rows)</span>

<span class="st">-- Look&#39;</span><span>s alright! :)</span>



<span class="ex">--</span><span> We can quit the postgresql console by typing \q</span>

<span class="va">app=</span><span># \</span><span class="ex">q</span>
</code></pre></div>
<p>Now our database is ready to be consumed by our app.</p>
<h5 id="record-types">Record Types</h5>
<p>By specificing the above schema, the framework automatically provides several types for us. Here is a short overview:</p>
<table>
<thead>
<tr><th style="text-align:right">Type</th><th><code>Post&#39; id title body</code></th></tr>
</thead>
<tbody>
<tr><td style="text-align:right">Definition</td><td><code>data Post&#39; id title body = Post {id :: id, title :: title, body :: body}</code></td></tr>
<tr><td style="text-align:right">Description</td><td>A helper type used by all the “real” types. All the content is variable</td></tr>
<tr><td style="text-align:right">Example</td><td><code>Post { id = (), title = &quot;Hello&quot;, body = () } :: Post&#39; () Text ()</code></td></tr>
</tbody>
</table>
<table>
<thead>
<tr><th>Type</th><th><code>Post</code></th></tr>
</thead>
<tbody>
<tr><td>Definition</td><td><code>type Post = Post&#39; (Id Post) Text Text</code></td></tr>
<tr><td>Description</td><td>A Post record from the database</td></tr>
<tr><td>Example</td><td><code>Post { id = cfefdc6c-c097-414c-91c0-cbc9a79fbe4f, title = &quot;Hello World&quot;, body = &quot;Some body text&quot; } :: Post</code></td></tr>
</tbody>
</table>
<table>
<thead>
<tr><th>Type</th><th><code>NewPost</code></th></tr>
</thead>
<tbody>
<tr><td>Definition</td><td><code>type NewPost = Post&#39; (FieldWithDefault (Id Post)) Text Text</code></td></tr>
<tr><td>Description</td><td>Post which is not yet saved to the database</td></tr>
<tr><td>Example</td><td><code>Post { id = Default, title = &quot;My new Post&quot;, body = &quot;Hello World&quot; } :: NewPost</code></td></tr>
</tbody>
</table>
<table>
<thead>
<tr><th>Type</th><th><code>Id Post</code></th></tr>
</thead>
<tbody>
<tr><td>Definition</td><td><code>newtype Id Post = Id UUID</code></td></tr>
<tr><td>Description</td><td>Type for the <code>id</code> field</td></tr>
<tr><td>Example</td><td><code>pack (read &quot;5a8d1be2-33e3-4d3f-9812-b16576fe6a38&quot; :: UUID) :: Id Post</code></td></tr>
</tbody>
</table>
<h3 id="4-apps-controllers-views">4. Apps, Controllers, Views</h3>
<p>TurboHaskell uses controllers to deal with incoming requests. We can use the built-in code generators to generate an empty controller for our posts.</p>
<p>A controller belongs to an application. Your whole project can consistent of multiple sub applications. Typically your production app will need e.g. an admin backend application next to the default web application.</p>
<p>We can run the code generator like this:</p>
<div class="source-code"><pre><code class="language-bash"><span>$ </span><span class="ex">new-controller</span><span> posts</span>

<span class="ex">+</span><span> Web/Controller/Posts.hs</span>
<span class="ex">*</span><span> Web/Routes.hs</span>
<span class="ex">*</span><span> Web/Types.hs</span>
<span class="ex">*</span><span> Web/App.hs (import)</span>
<span class="ex">*</span><span> Web/App.hs (import)</span>
<span class="ex">+</span><span> Web/View/Posts/Show.hs</span>
<span class="ex">+</span><span> Web/View/Posts/New.hs</span>
<span class="ex">+</span><span> Web/View/Posts/Edit.hs</span>
<span class="ex">+</span><span> Web/View/Posts/Index.hs</span>
</code></pre></div>
<p>You can see that lot’s of files have been created and updated.</p>
<p>Open your browser at <a href="http://localhost:8000/Posts">http://localhost:8000/Posts</a> to try out the new controller. The generator did all the initial work we need to get our usual CRUD actions going.</p>
<p>Here’s how the new controller looks like:</p>
<p><img src="images/Posts.png" alt="Screenshot of the /Posts view"></p>
<h5 id="new-types">New Types</h5>
<p>Let’s first take a closer look at the changes in <code>Web/Types.hs</code>. Here a new data structures was created:</p>
<div class="source-code"><pre><code class="language-haskell"><span class="kw">data</span><span> </span><span class="cr">PostsController</span><span>
    </span><span class="sy">=</span><span> </span><span class="cr">PostsAction</span><span>
    </span><span class="sy">|</span><span> </span><span class="cr">NewPostAction</span><span>
    </span><span class="sy">|</span><span> </span><span class="cr">ShowPostAction</span><span> </span><span class="sy">{</span><span> </span><span class="va">postId</span><span> </span><span class="sy">::</span><span> </span><span class="sy">!</span><span class="sy">(</span><span class="cr">Id</span><span> </span><span class="cr">Post</span><span class="sy">)</span><span> </span><span class="sy">}</span><span>
    </span><span class="sy">|</span><span> </span><span class="cr">CreatePostAction</span><span>
    </span><span class="sy">|</span><span> </span><span class="cr">EditPostAction</span><span> </span><span class="sy">{</span><span> </span><span class="va">postId</span><span> </span><span class="sy">::</span><span> </span><span class="sy">!</span><span class="sy">(</span><span class="cr">Id</span><span> </span><span class="cr">Post</span><span class="sy">)</span><span> </span><span class="sy">}</span><span>
    </span><span class="sy">|</span><span> </span><span class="cr">UpdatePostAction</span><span> </span><span class="sy">{</span><span> </span><span class="va">postId</span><span> </span><span class="sy">::</span><span> </span><span class="sy">!</span><span class="sy">(</span><span class="cr">Id</span><span> </span><span class="cr">Post</span><span class="sy">)</span><span> </span><span class="sy">}</span><span>
    </span><span class="sy">|</span><span> </span><span class="cr">DeletePostAction</span><span> </span><span class="sy">{</span><span> </span><span class="va">postId</span><span> </span><span class="sy">::</span><span> </span><span class="sy">!</span><span class="sy">(</span><span class="cr">Id</span><span> </span><span class="cr">Post</span><span class="sy">)</span><span> </span><span class="sy">}</span><span>
    </span><span class="kw">deriving</span><span> </span><span class="sy">(</span><span class="cr">Eq</span><span class="sy">,</span><span> </span><span class="cr">Show</span><span class="sy">,</span><span> </span><span class="cr">Data</span><span class="sy">)</span><span>
</span></code></pre></div>
<p>We have one constructor for each possible action. Here you can see a short description for all the constructors:</p>
<table>
<thead>
<tr><th>Action</th><th>Request</th><th>Description</th></tr>
</thead>
<tbody>
<tr><td><code>PostsAction</code></td><td><code>GET /Posts</code></td><td>Lists all posts</td></tr>
<tr><td><code>NewPostAction</code></td><td><code>GET /NewPost</code></td><td>Displays the form to create a post</td></tr>
<tr><td><code>ShowPostAction { postId = someId }</code></td><td><code>GET /ShowPost?postId={someId}</code></td><td>Shows the posts with id $someId</td></tr>
<tr><td><code>CreatePostAction</code></td><td><code>POST /CreatePost</code></td><td>Endpoint to create a Post</td></tr>
<tr><td><code>EditPostAction { postId = someId }</code></td><td><code>GET /EditPost?postId={someId}</code></td><td>Displays the form to edit a post</td></tr>
<tr><td><code>UpdatePostAction { postId = someId }</code></td><td><code>POST /UpdatePost?postId={someId}</code></td><td>Endpoint to submit a post update</td></tr>
<tr><td><code>DeletePostAction { postId = someId }</code></td><td><code>DELETE /DeletePost?postId={someId}</code></td><td>Deletes the post</td></tr>
</tbody>
</table>
<p>A request like “Show me the post with id <code>e57cfb85-ad55-4d5c-b3b6-3affed9c662c</code>“ can be represented like <code>ShowPostAction { postId = e57cfb85-ad55-4d5c-b3b6-3affed9c662c }</code>.</p>
<p>The type <code>Id Post</code> is just a UUID, but wrapped within a newtype (<code>newtype Id model = Id UUID</code>).</p>
<h5 id="controller-implementation-webcontrollerpostshs">Controller Implementation: <code>Web/Controller/Posts.hs</code></h5>
<p>The actual code running, when an action is executed, is defined in <code>Web/Controller/Posts.hs</code>. Let’s take a look, step by step.</p>
<h6 id="imports">Imports</h6>
<div class="source-code"><pre><code class="language-haskell"><span class="kw">module</span><span> </span><span class="cr">Web.Controller.Posts</span><span> </span><span class="kw">where</span><span>

</span><span class="kw">import</span><span> </span><span class="cr">Web.Controller.Prelude</span><span>
</span><span class="kw">import</span><span> </span><span class="cr">Web.View.Posts.Index</span><span>
</span><span class="kw">import</span><span> </span><span class="cr">Web.View.Posts.New</span><span>
</span><span class="kw">import</span><span> </span><span class="cr">Web.View.Posts.Edit</span><span>
</span><span class="kw">import</span><span> </span><span class="cr">Web.View.Posts.Show</span><span>
</span></code></pre></div>
<p>In the header we just see some imports. Controllers always import a special <code>Web.Controller.Prelude</code> module. It provides e.g. controller helpers and also the framework specific functions we will see below. The controller also imports all its views. Views are also just “normal” haskell modules.</p>
<h6 id="instance">Instance</h6>
<div class="source-code"><pre><code class="language-haskell"><span class="kw">instance</span><span> </span><span class="cr">Controller</span><span> </span><span class="cr">PostsController</span><span> </span><span class="kw">where</span><span>
</span></code></pre></div>
<p>The controller logic is specified by implementing an instance of the <code>Controller</code> type-class.</p>
<h6 id="index-action">Index Action</h6>
<p>This is where the interesting part begins. As we will see below, the controller implementation is just an <code>action</code> function, pattern mattching over our <code>data PostsController</code> structure we defined in <code>Web/Types.hs</code>.</p>
<div class="source-code"><pre><code class="language-haskell"><span>    </span><span class="va">action</span><span> </span><span class="cr">PostsAction</span><span> </span><span class="sy">=</span><span> </span><span class="kw">do</span><span>
        </span><span class="va">posts</span><span> </span><span class="sy">&lt;-</span><span> </span><span class="va">query</span><span> </span><span class="sy">@</span><span class="cr">Post</span><span> </span><span class="op">|&gt;</span><span> </span><span class="va">fetch</span><span>
        </span><span class="va">render</span><span> </span><span class="cr">IndexView</span><span> </span><span class="sy">{</span><span> </span><span class="sy">..</span><span> </span><span class="sy">}</span><span>
</span></code></pre></div>
<p>This is the index action. It’s called when opening <code>/Posts</code>. First it fetches all the posts from the database and then passes it along to the view. The <code>IndexView { .. }</code> is just shorthand for <code>IndexView { posts = posts }</code>.</p>
<h6 id="new-action">New Action</h6>
<div class="source-code"><pre><code class="language-haskell"><span>    </span><span class="va">action</span><span> </span><span class="cr">NewPostAction</span><span> </span><span class="sy">=</span><span> </span><span class="kw">do</span><span>
        </span><span class="kw">let</span><span> </span><span class="va">post</span><span> </span><span class="sy">=</span><span> </span><span class="va">newRecord</span><span>
        </span><span class="va">render</span><span> </span><span class="cr">NewView</span><span> </span><span class="sy">{</span><span> </span><span class="sy">..</span><span> </span><span class="sy">}</span><span>
</span></code></pre></div>
<p>This is our endpoint for <code>/NewPost</code>. It just creates an empty new post and then passes it to the <code>NewView</code>. The <code>newRecord</code> is giving us an empty <code>Post</code> model. It’s equivalent to manually writing <code>Post { id = Default, title = &quot;&quot;, body = &quot;&quot; }</code>.</p>
<h6 id="show-action">Show Action</h6>
<div class="source-code"><pre><code class="language-haskell"><span>    </span><span class="va">action</span><span> </span><span class="cr">ShowPostAction</span><span> </span><span class="sy">{</span><span> </span><span class="va">postId</span><span> </span><span class="sy">}</span><span> </span><span class="sy">=</span><span> </span><span class="kw">do</span><span>
        </span><span class="va">post</span><span> </span><span class="sy">&lt;-</span><span> </span><span class="va">fetch</span><span> </span><span class="va">postId</span><span>
        </span><span class="va">render</span><span> </span><span class="cr">ShowView</span><span> </span><span class="sy">{</span><span> </span><span class="sy">..</span><span> </span><span class="sy">}</span><span>
</span></code></pre></div>
<p>This is our show action at <code>/ShowPost?postId=postId</code>. Here we pattern match on the <code>postId</code> field of <code>ShowPostAction</code> to get post id of the given request. Then we just call <code>fetch</code> on that <code>postId</code> which gives us the specific <code>Post</code> record. Then we just pass that post to the view.</p>
<h6 id="edit-action">Edit Action</h6>
<div class="source-code"><pre><code class="language-haskell"><span>    </span><span class="va">action</span><span> </span><span class="cr">EditPostAction</span><span> </span><span class="sy">{</span><span> </span><span class="va">postId</span><span> </span><span class="sy">}</span><span> </span><span class="sy">=</span><span> </span><span class="kw">do</span><span>
        </span><span class="va">post</span><span> </span><span class="sy">&lt;-</span><span> </span><span class="va">fetch</span><span> </span><span class="va">postId</span><span>
        </span><span class="va">render</span><span> </span><span class="cr">EditView</span><span> </span><span class="sy">{</span><span> </span><span class="sy">..</span><span> </span><span class="sy">}</span><span>
</span></code></pre></div>
<p>Our <code>/EditPost?postId=postId</code> action. It’s pretty much the same as in the <code>action ShowPostAction</code>, just with a different view.</p>
<h6 id="update-action">Update Action</h6>
<div class="source-code"><pre><code class="language-haskell"><span>    </span><span class="va">action</span><span> </span><span class="cr">UpdatePostAction</span><span> </span><span class="sy">{</span><span> </span><span class="va">postId</span><span> </span><span class="sy">}</span><span> </span><span class="sy">=</span><span> </span><span class="kw">do</span><span>
        </span><span class="va">post</span><span> </span><span class="sy">&lt;-</span><span> </span><span class="va">fetch</span><span> </span><span class="va">postId</span><span>
        </span><span class="va">post</span><span>
            </span><span class="op">|&gt;</span><span> </span><span class="va">buildPost</span><span>
            </span><span class="op">|&gt;</span><span> </span><span class="va">ifValid</span><span> </span><span class="sy">\</span><span class="sy">case</span><span>
                </span><span class="cr">Left</span><span> </span><span class="va">post</span><span> </span><span class="sy">-&gt;</span><span> </span><span class="va">render</span><span> </span><span class="cr">EditView</span><span> </span><span class="sy">{</span><span> </span><span class="sy">..</span><span> </span><span class="sy">}</span><span>
                </span><span class="cr">Right</span><span> </span><span class="va">post</span><span> </span><span class="sy">-&gt;</span><span> </span><span class="kw">do</span><span>
                    </span><span class="va">post</span><span> </span><span class="sy">&lt;-</span><span> </span><span class="va">post</span><span> </span><span class="op">|&gt;</span><span> </span><span class="va">updateRecord</span><span>
                    </span><span class="va">setSuccessMessage</span><span> </span><span class="st">&quot;Post updated&quot;</span><span>
                    </span><span class="va">redirectTo</span><span> </span><span class="cr">EditPostAction</span><span> </span><span class="sy">{</span><span> </span><span class="sy">..</span><span> </span><span class="sy">}</span><span>
</span></code></pre></div>
<p>This action deals with update requests for a specific post. As usual we pattern match on the <code>postId</code> and fetch it.</p>
<p>The interesting part is <code>buildPost</code>. It is a helper function defined later in the controller: <code>buildPost = fill @[&quot;title&quot;, &quot;body&quot;]</code>. The <code>fill</code> call inside <code>buildPost</code> reads the <code>title</code> and <code>body</code> attributes from the browser request and fills them into the <code>post</code> record. The <code>buildPost</code> is also the place for validation logic.</p>
<p><code>ifValid</code> returns <code>Either Post Post</code>. <code>Left post</code> means that e.g. the <code>title</code> or <code>body</code> did not pass validation. <code>Right post</code> means that all parameters could be set on <code>post</code> without any errors.</p>
<p>In the error case (<code>Left post -&gt;</code>) we just re-render the <code>EditView</code>. The <code>EditView</code> then tells the user about validation errors.</p>
<p>In the success case (<code>Right post -&gt;</code>) we save the updated post to the database (with <code>updateRecord</code>). Then we set a success message and redirect the user back to the edit view.</p>
<div class="source-code"><pre><code class="language-haskell"><span>    </span><span class="va">action</span><span> </span><span class="cr">CreatePostAction</span><span> </span><span class="sy">=</span><span> </span><span class="kw">do</span><span>
        </span><span class="kw">let</span><span> </span><span class="va">post</span><span> </span><span class="sy">=</span><span> </span><span class="va">newRecord</span><span> </span><span class="sy">@</span><span class="cr">NewPost</span><span>
        </span><span class="va">post</span><span>
            </span><span class="op">|&gt;</span><span> </span><span class="va">buildPost</span><span>
            </span><span class="op">|&gt;</span><span> </span><span class="va">ifValid</span><span> </span><span class="sy">\</span><span class="sy">case</span><span>
                </span><span class="cr">Left</span><span> </span><span class="va">post</span><span> </span><span class="sy">-&gt;</span><span> </span><span class="va">render</span><span> </span><span class="cr">NewView</span><span> </span><span class="sy">{</span><span> </span><span class="sy">..</span><span> </span><span class="sy">}</span><span> 
                </span><span class="cr">Right</span><span> </span><span class="va">post</span><span> </span><span class="sy">-&gt;</span><span> </span><span class="kw">do</span><span>
                    </span><span class="va">post</span><span> </span><span class="sy">&lt;-</span><span> </span><span class="va">post</span><span> </span><span class="op">|&gt;</span><span> </span><span class="va">createRecord</span><span>
                    </span><span class="va">setSuccessMessage</span><span> </span><span class="st">&quot;Post created&quot;</span><span>
                    </span><span class="va">redirectTo</span><span> </span><span class="cr">PostsAction</span><span>
</span></code></pre></div>
<p>Our create action, dealing with <code>POST /CreatePost</code> requests.</p>
<p>It’s pretty much like the update action. When the validation succeeded, it saves the record to the database using <code>createRecord</code>.</p>
<div class="source-code"><pre><code class="language-haskell"><span>    </span><span class="va">action</span><span> </span><span class="cr">DeletePostAction</span><span> </span><span class="sy">{</span><span> </span><span class="va">postId</span><span> </span><span class="sy">}</span><span> </span><span class="sy">=</span><span> </span><span class="kw">do</span><span>
        </span><span class="va">post</span><span> </span><span class="sy">&lt;-</span><span> </span><span class="va">fetch</span><span> </span><span class="va">postId</span><span>
        </span><span class="va">deleteRecord</span><span> </span><span class="va">post</span><span>
        </span><span class="va">setSuccessMessage</span><span> </span><span class="st">&quot;Post deleted&quot;</span><span>
        </span><span class="va">redirectTo</span><span> </span><span class="cr">PostsAction</span><span>
</span></code></pre></div>
<p>The last action is dealing with <code>DELETE /DeletePost?postId=postId</code> requests. It’s pretty much like the other actions, we just call <code>deleteRecord</code> here.</p>
<h5 id="routes">Routes</h5>
<p>The router is configured in <code>Web/Routes.hs</code>. The generator just places a single line there:</p>
<div class="source-code"><pre><code class="language-haskell"><span class="kw">instance</span><span> </span><span class="cr">AutoRoute</span><span> </span><span class="cr">PostsController</span><span>
</span></code></pre></div>
<p>This empty instance magically sets up the routing for all the actions. Later you will learn how you can customize the urls according to your needs (e.g. “beautiful urls” for SEO).</p>
<h5 id="views">Views</h5>
<p>We should also quickly take a look at our views.</p>
<p>Let first look at the show view in <code>Web/View/Posts/Show.hs</code>:</p>
<div class="source-code"><pre><code class="language-haskell"><span class="kw">module</span><span> </span><span class="cr">Web.View.Posts.Show</span><span> </span><span class="kw">where</span><span>
</span><span class="kw">import</span><span> </span><span class="cr">Web.View.Prelude</span><span>

</span><span class="kw">data</span><span> </span><span class="cr">ShowView</span><span> </span><span class="sy">=</span><span> </span><span class="cr">ShowView</span><span> </span><span class="sy">{</span><span> </span><span class="va">post</span><span> </span><span class="sy">::</span><span> </span><span class="cr">Post</span><span> </span><span class="sy">}</span><span>

</span><span class="kw">instance</span><span> </span><span class="cr">View</span><span> </span><span class="cr">ShowView</span><span> </span><span class="kw">where</span><span>
    </span><span class="kw">type</span><span> </span><span class="cr">ViewContextForView</span><span> </span><span class="cr">ShowView</span><span> </span><span class="sy">=</span><span> </span><span class="cr">ViewContext</span><span>
    </span><span class="va">html</span><span> </span><span class="cr">ShowView</span><span> </span><span class="sy">{</span><span> </span><span class="sy">..</span><span> </span><span class="sy">}</span><span> </span><span class="sy">=</span><span> </span><span class="sy">[hsx|
        &lt;nav&gt;
            &lt;ol class=&quot;breadcrumb&quot;&gt;
                &lt;li class=&quot;breadcrumb-item&quot;&gt;&lt;a href={PostsAction}&gt;Posts&lt;/a&gt;&lt;/li&gt;
                &lt;li class=&quot;breadcrumb-item active&quot;&gt;Show Post&lt;/li&gt;
            &lt;/ol&gt;
        &lt;/nav&gt;
        &lt;h1&gt;Show Post&lt;/h1&gt;
    |]</span><span>
</span></code></pre></div>
<p>We can see that the <code>ShowView</code> is just a data definition. There is also an <code>View ShowView</code> instance. The html-like syntax inside the <code>html</code> function is, what we call it, <code>hsx</code> code. It’s just like react’s jsx. You can write html code as usual there. Everything inside the <code>[hsx|my html|]</code> block is also type-checked and converted to haskell code at compile-time.</p>
<p>Now that we have a rough overview of all the parts belonging to our <code>Post</code>, it’s time to do some coding ourselves.</p>
<h3 id="5-extending-the-blog">5. Extending the Blog</h3>
<p>The generated controller already feels close to a super simple blog. Now it’s time to make it more beautiful.</p>
<h4 id="creating-a-post">Creating a Post</h4>
<p>First we quickly need to create a new blog post. Open <a href="http://localhost:8000/Posts">http://localhost:8000/Posts</a> and click on “+ New”. Then enter <code>Hello World!</code> into the “Title” field and <code>Lorem ipsum dolor sit amet, consetetur sadipscing elitr, sed diam nonumy eirmod tempor invidunt ut labore et dolore magna aliquyam</code> into “Body”.</p>
<p>Click “Save Post”. You should now see the new post listed on the index view.</p>
<h4 id="displaying-a-post">Displaying a Post</h4>
<p>Let’s first improve the show view. Right now the headline is “Show Post”, and the actual Post body is never shown.</p>
<p>Open the <code>Web/View/Posts/Show.hs</code> and replace <code>&lt;h1&gt;Show Post&lt;/h1&gt;</code> with <code>&lt;h1&gt;{get #title post}&lt;/h1&gt;</code>. Also add a <code>&lt;div&gt;{get #body post}&lt;/div&gt;</code> below the <code>&lt;h1&gt;</code>.</p>
<p>The hsx code should now look like this:</p>
<div class="source-code"><pre><code class="language-html"><span class="kw">&lt;nav&gt;</span>
<span>    </span><span class="kw">&lt;ol</span><span class="ot"> class=</span><span class="st">&quot;breadcrumb&quot;</span><span class="kw">&gt;</span>
<span>        </span><span class="kw">&lt;li</span><span class="ot"> class=</span><span class="st">&quot;breadcrumb-item&quot;</span><span class="kw">&gt;&lt;a</span><span class="ot"> href=</span><span class="st">{PostsAction}</span><span class="kw">&gt;</span><span>Posts</span><span class="kw">&lt;/a&gt;&lt;/li&gt;</span>
<span>        </span><span class="kw">&lt;li</span><span class="ot"> class=</span><span class="st">&quot;breadcrumb-item active&quot;</span><span class="kw">&gt;</span><span>Show Post</span><span class="kw">&lt;/li&gt;</span>
<span>    </span><span class="kw">&lt;/ol&gt;</span>
<span class="kw">&lt;/nav&gt;</span>
<span class="kw">&lt;h1&gt;</span><span>{get #title post}</span><span class="kw">&lt;/h1&gt;</span>
<span class="kw">&lt;div&gt;</span><span>{get #body post}</span><span class="kw">&lt;/div&gt;</span>
</code></pre></div>
<p>After you saved the changes, you should see that the changes have been reflected in the browser already. In the background the page has been refreshed automatically (technically the page has been patched using a vdom library).</p>
<h4 id="display-all-posts">Display all posts</h4>
<p>After creating your post, you should have already seen that posts list is right now displaying all the post fields. Let’s change it to only display the post’s title.</p>
<p>Open the <code>Web/View/Posts/Index.hs</code> and replace <code>&lt;td&gt;{post}&lt;/td&gt;</code> with <code>&lt;td&gt;{get #title post}&lt;/td&gt;</code>.</p>
<p>Let’s also make it clickable by wrapping it in a link. We can just put a <code>&lt;a href={ShowPostAction (get #id post)}&gt;</code> around it. The line should now look like <code>&lt;td&gt;&lt;a href={ShowPostAction (get #id post)}&gt;{get #title post}&lt;/a&gt;&lt;/td&gt;</code>.</p>
<p>Now we can also remove the “Show” link. We can do that by removing the next line <code>&lt;td&gt;&lt;a href={ShowPostAction (get #id post)}&gt;Show&lt;/a&gt;&lt;/td&gt;</code>.</p>
<h4 id="adding-validation">Adding Validation</h4>
<p>Let’s make sure that every post has atleast a title. Validations can be defined inside our controller <code>Web/Controller/Posts.hs</code>.</p>
<p>Right now at the bottom of the file we have this:</p>
<div class="source-code"><pre><code class="language-haskell"><span class="va">buildPost</span><span> </span><span class="sy">=</span><span> </span><span class="va">fill</span><span> </span><span class="sy">@</span><span class="sy">[</span><span class="st">&quot;title&quot;</span><span class="sy">,</span><span class="st">&quot;body&quot;</span><span class="sy">]</span><span>
</span></code></pre></div>
<p>Replace the implementation with this:</p>
<div class="source-code"><pre><code class="language-haskell"><span class="va">buildPost</span><span> </span><span class="va">post</span><span> </span><span class="sy">=</span><span> </span><span class="va">post</span><span>
    </span><span class="op">|&gt;</span><span> </span><span class="va">fill</span><span> </span><span class="sy">@</span><span class="sy">[</span><span class="st">&quot;title&quot;</span><span class="sy">,</span><span class="st">&quot;body&quot;</span><span class="sy">]</span><span>
    </span><span class="op">|&gt;</span><span> </span><span class="va">validateField</span><span> </span><span class="va">#title</span><span> </span><span class="va">nonEmpty</span><span>
</span></code></pre></div>
<p>Now open <a href="http://localhost:8000/Posts/new">http://localhost:8000/Posts/new</a> and click “Save Post” without filling the text fields. You will get a “This field cannot be empty”.</p>
<p>That’s how easy it is, to validate your models with TurboHaskell.</p>
<h4 id="timestamps">Timestamps</h4>
<p>It would be nice to always show the latest post on the index view. Let’s add a timestamp to do exactly that.</p>
<p>Before we change our database schema, it’s time to quickly save our current database state. For that you can just run <code>make dumpdb</code>:</p>
<div class="source-code"><pre><code class="language-bash"><span>$ </span><span class="fu">make</span><span> dumpdb</span>
</code></pre></div>
<p>Take a look at <code>Application/Fixtures.sql</code>, the file should look like this now:</p>
<div class="source-code"><pre><code class="language-sql"><span class="co">-- .......</span>
<span class="co">-- .......</span>

<span class="kw">INSERT</span><span> </span><span class="kw">INTO</span><span> </span><span class="kw">public</span><span>.posts </span><span class="kw">VALUES</span><span> (</span><span class="st">&#39;fcbd2232-cdc2-4d0c-9312-1fd94448d90a&#39;</span><span>, </span><span class="st">&#39;Hello World!&#39;</span><span>, </span><span class="st">&#39;Lorem ipsum dolor sit amet, consetetur sadipscing elitr, sed diam nonumy eirmod tempor invidunt ut labore et dolore magna aliquyam&#39;</span><span>);</span>

</code></pre></div>
<p>All our existing posts are saved here. You can also commit this file to git to share your fixtures with your team mates. We will need the saved fixtures in a moment.</p>
<p>Let’s add our timestamp column. Open <code>Application/Schema.hs</code> and add <code>+ field &quot;created_at&quot; timestamp { defaultValue = Just (SqlDefaultValue &quot;NOW()&quot;) }</code> to the <code>posts</code> table. We set the column value to <code>NOW()</code> by default, so the <code>created_at</code> field is automatically set to the current time.</p>
<div class="source-code"><pre><code class="language-haskell"><span class="va">table</span><span> </span><span class="st">&quot;posts&quot;</span><span>
    </span><span class="op">+</span><span> </span><span class="va">field</span><span> </span><span class="st">&quot;id&quot;</span><span> </span><span class="va">primaryKey</span><span>
    </span><span class="op">+</span><span> </span><span class="va">field</span><span> </span><span class="st">&quot;title&quot;</span><span> </span><span class="va">text</span><span>
    </span><span class="op">+</span><span> </span><span class="va">field</span><span> </span><span class="st">&quot;body&quot;</span><span> </span><span class="va">text</span><span>
    </span><span class="op">+</span><span> </span><span class="va">field</span><span> </span><span class="st">&quot;created_at&quot;</span><span> </span><span class="va">timestamp</span><span> </span><span class="sy">{</span><span> </span><span class="va">defaultValue</span><span> </span><span class="sy">=</span><span> </span><span class="cr">Just</span><span> </span><span class="sy">(</span><span class="cr">SqlDefaultValue</span><span> </span><span class="st">&quot;NOW()&quot;</span><span class="sy">)</span><span> </span><span class="sy">}</span><span>
</span></code></pre></div>
<p>Now open the browser again. You will see <code>Something went wrong</code>. In the dev server console you will see something along <code>mismatch between number of columns to convert and number in target type</code>.</p>
<p>The application now expects the <code>created_at</code> field to be set inside the database. Our <code>posts</code> table does not know about that column yet.</p>
<p>Run the following command to fix that:</p>
<div class="source-code"><pre><code class="language-bash"><span>$ </span><span class="fu">make</span><span> db</span>
</code></pre></div>
<p>This command will destroy the database, reload the schema and then insert the fixtures. The last step is the reason why we saved our database state to <code>Application/Fixtures.sql</code> a moment ago.</p>
<p>You can open <a href="http://localhost:8000/Posts">http://localhost:8000/Posts</a> again. The error is gone now.</p>
<p>Now we can order the posts by our new <code>created_at</code> field. Open <code>Web/Controller/Posts.hs</code> and add <code>orderByDesc #createdAt</code> like this inside the <code>action PostsAction</code>:</p>
<div class="source-code"><pre><code class="language-haskell"><span class="va">action</span><span> </span><span class="cr">PostsAction</span><span> </span><span class="sy">=</span><span> </span><span class="kw">do</span><span>
    </span><span class="va">posts</span><span> </span><span class="sy">&lt;-</span><span> </span><span class="va">query</span><span> </span><span class="sy">@</span><span class="cr">Post</span><span>
        </span><span class="op">|&gt;</span><span> </span><span class="va">orderByDesc</span><span> </span><span class="va">#createdAt</span><span>
        </span><span class="op">|&gt;</span><span> </span><span class="va">fetch</span><span>
    </span><span class="va">render</span><span> </span><span class="cr">IndexView</span><span> </span><span class="sy">{</span><span> </span><span class="sy">..</span><span> </span><span class="sy">}</span><span>
</span></code></pre></div>
<p>Let’s also show the creation time in the <code>ShowView</code> in <code>Web/View/Posts/Show.hs</code>. There we add <code>&lt;p&gt;{timeAgo (get #createdAt post)}&lt;/p&gt;</code> below the title:</p>
<div class="source-code"><pre><code class="language-html"><span class="kw">&lt;nav&gt;</span>
<span>    </span><span class="kw">&lt;ol</span><span class="ot"> class=</span><span class="st">&quot;breadcrumb&quot;</span><span class="kw">&gt;</span>
<span>        </span><span class="kw">&lt;li</span><span class="ot"> class=</span><span class="st">&quot;breadcrumb-item&quot;</span><span class="kw">&gt;&lt;a</span><span class="ot"> href=</span><span class="st">{PostsAction}</span><span class="kw">&gt;</span><span>Posts</span><span class="kw">&lt;/a&gt;&lt;/li&gt;</span>
<span>        </span><span class="kw">&lt;li</span><span class="ot"> class=</span><span class="st">&quot;breadcrumb-item active&quot;</span><span class="kw">&gt;</span><span>Show Post</span><span class="kw">&lt;/li&gt;</span>
<span>    </span><span class="kw">&lt;/ol&gt;</span>
<span class="kw">&lt;/nav&gt;</span>
<span class="kw">&lt;h1&gt;</span><span>{get #title post}</span><span class="kw">&lt;/h1&gt;</span>
<span class="kw">&lt;p&gt;</span><span>{timeAgo (get #createdAt post)}</span><span class="kw">&lt;/p&gt;</span>
<span class="kw">&lt;div&gt;</span><span>{get #body post}</span><span class="kw">&lt;/div&gt;</span>
</code></pre></div>
<p>Open the view to check that it’s working. If everything is fine, you will see something like <code>5 minutes ago</code> below the title. The <code>timeAgo</code> helper uses a bit of javascript to automatically displays the given timestamp in the current time zone and in a relative format. In case you want to show the absolute time (like <code>10.6.2019, 15:58 Uhr</code>), just use <code>dateTime</code> instead of <code>timeAgo</code>.</p>
<h4 id="markdown">Markdown</h4>
<p>Right now our posts can only be plain text. Let’s make it more powerful by adding support for markdown.</p>
<h5 id="adding-a-markdown-library">Adding a Markdown Library</h5>
<p>To deal with markdown, instead of implementing our own markdown parser, let’s just use an existing package. There’s the excellt <code>mmark</code> package we can use.</p>
<p>To install this package, open the <code>default.nix</code> file and append <code>mmark</code> to the <code>haskellDeps</code> list. The file will now look like this:</p>
<div class="source-code"><pre><code class="language-nix"><span class="bu">let</span>
<span>    </span><span class="ex">haskellEnv</span><span> = import ./TurboHaskell/NixSupport/default.nix {</span>
<span>        </span><span class="ex">compiler</span><span> = </span><span class="st">&quot;ghc844&quot;</span><span class="kw">;</span>
<span>        </span><span class="ex">haskellDeps</span><span> = p: with p</span><span class="kw">;</span><span class="bu"> [</span>
<span>            cabal-install</span>
<span>            base</span>
<span>            classy-prelude</span>
<span>            directory</span>
<span>            string-conversions</span>
<span>            wai</span>
<span>            mtl</span>
<span>            blaze-html</span>
<span>            blaze-markup</span>
<span>            wai</span>
<span>            mtl</span>
<span>            text</span>
<span>            postgresql-simple</span>
<span>            wai-util</span>
<span>            aeson</span>
<span>            uuid</span>
<span>            hlint</span>
<span>            parsec</span>
<span>            template-haskell</span>
<span>            interpolate</span>
<span>            uri-encode</span>
<span>            generic-lens</span>
<span>            tz</span>
<span>            turbohaskell</span>
<span>            mmark</span>
<span>        ];</span>
<span>        otherDeps </span><span class="ot">=</span><span> p: with p; [</span>
<span>            imagemagick</span>
<span>        ];</span>
<span>        projectPath </span><span class="ot">=</span><span> ./.;</span>
<span>    };</span>
<span>in</span>
<span>    haskellEnv</span>
</code></pre></div>
<p>Now restart the development server by pressing CTRL+C and then typing <code>make</code> again. We will see that mmark is going to be installed.</p>
<h5 id="markdown-rendering">Markdown Rendering</h5>
<p>Now that we have <code>mmark</code> installed, we need to integrate it into our <code>ShowView</code>. First we need to import it: Add <code>import qualified Text.MMark as MMark</code> to the top of <code>Web/View/Posts/Show.hs</code>.</p>
<p>Next change <code>{get #body post}</code> to <code>{get #body post |&gt; renderMarkdown}</code>. This pipes the body field through a function <code>renderMarkdown</code>. Of course we also have to define the function now.</p>
<p>Add the following to the bottom of the show view:</p>
<div class="source-code"><pre><code class="language-haskell"><span class="va">renderMarkdown</span><span> </span><span class="va">text</span><span> </span><span class="sy">=</span><span> </span><span class="va">text</span><span>
</span></code></pre></div>
<p>This function now does nothing except return it’s input text. Our markdown package provides two functions, <code>MMark.parse</code> and <code>MMark.render</code> to deal with the markdown. Let’s first deal with parsing:</p>
<div class="source-code"><pre><code class="language-haskell"><span class="va">renderMarkdown</span><span> </span><span class="va">text</span><span> </span><span class="sy">=</span><span> </span><span class="va">text</span><span> </span><span class="op">|&gt;</span><span> </span><span class="va">MMark.parse</span><span> </span><span class="st">&quot;&quot;</span><span>
</span></code></pre></div>
<p>The empty string we pass to <code>MMark.parse</code> is usually the file name of the <code>.markdown</code> file, as we don’t have any markdown file, we just pass an empty string.</p>
<p>Now open the web app and take a look at a blog post. You will see something like this:</p>
<pre><code>Right MMark {..}
</code></pre>
<p>This is the parsed representation of the markdown. Of course that’s not very helpful. We also have to connect it with <code>MMark.render</code> to get html code for our markdown. Replace the <code>renderMarkdown</code> with the following code:</p>
<div class="source-code"><pre><code class="language-haskell"><span class="va">renderMarkdown</span><span> </span><span class="va">text</span><span> </span><span class="sy">=</span><span>
    </span><span class="kw">case</span><span> </span><span class="va">text</span><span> </span><span class="op">|&gt;</span><span> </span><span class="va">MMark.parse</span><span> </span><span class="st">&quot;&quot;</span><span> </span><span class="kw">of</span><span>
        </span><span class="cr">Left</span><span> </span><span class="va">error</span><span> </span><span class="sy">-&gt;</span><span> </span><span class="st">&quot;Something went wrong&quot;</span><span>
        </span><span class="cr">Right</span><span> </span><span class="va">markdown</span><span> </span><span class="sy">-&gt;</span><span> </span><span class="va">MMark.render</span><span> </span><span class="va">markdown</span><span> </span><span class="op">|&gt;</span><span> </span><span class="va">tshow</span><span> </span><span class="op">|&gt;</span><span> </span><span class="va">preEscapedToHtml</span><span>
</span></code></pre></div>
<p>The show view will now show real formatted text, as we would have expected.</p>
<h5 id="forms-validation">Forms &amp; Validation</h5>
<p>Let’s also quickly update our form. Right now we have a one-line text field there. We can replace it with a textarea to support multi line text.</p>
<p>Open <code>Web/View/Posts/Edit.hs</code> and change <code>{textField #body}</code> to <code>{textareaField #body}</code>. We can also add a short hint that the text area supports markdown: Replace <code>{textareaField #body}</code> with <code>{(textareaField #body) { helpText = &quot;You can use markdown here&quot;} }</code>.</p>
<div class="source-code"><pre><code class="language-haskell"><span class="va">renderForm</span><span> </span><span class="sy">::</span><span> </span><span class="cr">Post</span><span> </span><span class="sy">-&gt;</span><span> </span><span class="cr">Html</span><span>
</span><span class="va">renderForm</span><span> </span><span class="va">post</span><span> </span><span class="sy">=</span><span> </span><span class="va">formFor</span><span> </span><span class="va">post</span><span> </span><span class="sy">[hsx|
    {textField #title}
    {(textareaField #body) { helpText = &quot;You can use markdown here&quot;} }
    {submitButton}
|]</span><span>
</span></code></pre></div>
<p>After that, do the same in <code>Web/View/Posts/New.hs</code>.</p>
<p>We can also add an error message when the user tries to save invalid markdown. We can quickly write a custom validator for that:</p>
<p>Open <code>Web/Controller/Posts.hs</code> and import <code>MMark</code> at the top:</p>
<div class="source-code"><pre><code class="language-haskell"><span class="kw">import</span><span> </span><span class="kw">qualified</span><span> </span><span class="cr">Text.MMark</span><span> </span><span class="kw">as</span><span> </span><span class="cr">MMark</span><span>
</span></code></pre></div>
<p>Then add this custom validator to the bottom of the file:</p>
<div class="source-code"><pre><code class="language-haskell"><span class="va">isMarkdown</span><span> </span><span class="sy">::</span><span> </span><span class="cr">Text</span><span> </span><span class="sy">-&gt;</span><span> </span><span class="cr">ValidatorResult</span><span>
</span><span class="va">isMarkdown</span><span> </span><span class="va">text</span><span> </span><span class="sy">=</span><span>
    </span><span class="kw">case</span><span> </span><span class="va">MMark.parse</span><span> </span><span class="st">&quot;&quot;</span><span> </span><span class="va">text</span><span> </span><span class="kw">of</span><span>
        </span><span class="cr">Left</span><span> </span><span class="sy">_</span><span> </span><span class="sy">-&gt;</span><span> </span><span class="cr">Failure</span><span> </span><span class="st">&quot;Please provide valid markdown&quot;</span><span>
        </span><span class="cr">Right</span><span> </span><span class="sy">_</span><span> </span><span class="sy">-&gt;</span><span> </span><span class="cr">Success</span><span>
</span></code></pre></div>
<p>We can use the validator by adding a new <code>validateField #body isMarkdown</code> line to the <code>buildPost</code> function:</p>
<div class="source-code"><pre><code class="language-haskell"><span class="va">buildPost</span><span> </span><span class="va">post</span><span> </span><span class="sy">=</span><span> </span><span class="va">post</span><span>
    </span><span class="op">|&gt;</span><span> </span><span class="va">fill</span><span> </span><span class="sy">@</span><span class="sy">[</span><span class="st">&quot;title&quot;</span><span class="sy">,</span><span class="st">&quot;body&quot;</span><span class="sy">]</span><span>
    </span><span class="op">|&gt;</span><span> </span><span class="va">validateField</span><span> </span><span class="va">#title</span><span> </span><span class="va">nonEmpty</span><span>
    </span><span class="op">|&gt;</span><span> </span><span class="va">validateField</span><span> </span><span class="va">#body</span><span> </span><span class="va">nonEmpty</span><span>
    </span><span class="op">|&gt;</span><span> </span><span class="va">validateField</span><span> </span><span class="va">#body</span><span> </span><span class="va">isMarkdown</span><span>
</span></code></pre></div>
<p>Create a new post with just <code>#</code> (a headline without any text) as the content to see our new error message.</p>
<h3 id="6-a-second-model">6. A Second Model</h3>
<h4 id="61-schema-modeling">6.1 Schema Modeling</h4>
<p>It’s time to add comments to our blog. For that open the <code>Schema.hs</code> and add a new table <code>comments</code> with the fields <code>id</code>, <code>post_id</code>, <code>author</code> and <code>body</code>:</p>
<div class="source-code"><pre><code class="language-haskell"><span class="va">table</span><span> </span><span class="st">&quot;comments&quot;</span><span>
    </span><span class="op">+</span><span> </span><span class="va">field</span><span> </span><span class="st">&quot;id&quot;</span><span> </span><span class="va">primaryKey</span><span>
    </span><span class="op">+</span><span> </span><span class="va">field</span><span> </span><span class="st">&quot;post_id&quot;</span><span> </span><span class="va">uuid</span><span> </span><span class="sy">{</span><span> </span><span class="va">references</span><span> </span><span class="sy">=</span><span> </span><span class="cr">Just</span><span> </span><span class="st">&quot;posts&quot;</span><span class="sy">,</span><span> </span><span class="va">onDelete</span><span> </span><span class="sy">=</span><span> </span><span class="cr">Cascade</span><span> </span><span class="sy">}</span><span>
    </span><span class="op">+</span><span> </span><span class="va">field</span><span> </span><span class="st">&quot;author&quot;</span><span> </span><span class="va">text</span><span>
    </span><span class="op">+</span><span> </span><span class="va">field</span><span> </span><span class="st">&quot;body&quot;</span><span> </span><span class="va">text</span><span>
</span></code></pre></div>
<p>The <code>uuid { references = Just &quot;posts&quot;, onDelete = Cascade }</code> column type specifies that we have a uuid column including a foreign key constraint to the <code>posts</code> table. The <code>onDelete</code> option is set to cascade to tell our database to delete the comments when the post is removed.</p>
<p>The <code>Application/Schema.hs</code> will now look like this:</p>
<div class="source-code"><pre><code class="language-haskell"><span class="kw">module</span><span> </span><span class="cr">Application.Schema</span><span> </span><span class="kw">where</span><span>
</span><span class="kw">import</span><span> </span><span class="cr">ClassyPrelude</span><span> </span><span class="sy">(</span><span class="cr">Maybe</span><span> </span><span class="sy">(</span><span class="sy">..</span><span class="sy">)</span><span class="sy">,</span><span> </span><span class="sy">(</span><span class="op">&lt;&gt;</span><span class="sy">)</span><span class="sy">,</span><span> </span><span class="cr">Bool</span><span> </span><span class="sy">(</span><span class="sy">..</span><span class="sy">)</span><span class="sy">)</span><span>
</span><span class="kw">import</span><span> </span><span class="cr">TurboHaskell.SchemaSupport</span><span>

</span><span class="va">database</span><span> </span><span class="sy">=</span><span> </span><span class="sy">[</span><span>
    </span><span class="va">table</span><span> </span><span class="st">&quot;posts&quot;</span><span>
        </span><span class="op">+</span><span> </span><span class="va">field</span><span> </span><span class="st">&quot;id&quot;</span><span> </span><span class="va">primaryKey</span><span>
        </span><span class="op">+</span><span> </span><span class="va">field</span><span> </span><span class="st">&quot;title&quot;</span><span> </span><span class="va">text</span><span>
        </span><span class="op">+</span><span> </span><span class="va">field</span><span> </span><span class="st">&quot;body&quot;</span><span> </span><span class="va">text</span><span>
        </span><span class="op">+</span><span> </span><span class="va">field</span><span> </span><span class="st">&quot;created_at&quot;</span><span> </span><span class="va">timestamp</span><span> </span><span class="sy">{</span><span> </span><span class="va">defaultValue</span><span> </span><span class="sy">=</span><span> </span><span class="cr">Just</span><span> </span><span class="sy">(</span><span class="cr">SqlDefaultValue</span><span> </span><span class="st">&quot;NOW()&quot;</span><span class="sy">)</span><span> </span><span class="sy">}</span><span>
        </span><span class="sy">,</span><span>
    </span><span class="va">table</span><span> </span><span class="st">&quot;comments&quot;</span><span>
        </span><span class="op">+</span><span> </span><span class="va">field</span><span> </span><span class="st">&quot;id&quot;</span><span> </span><span class="va">primaryKey</span><span>
        </span><span class="op">+</span><span> </span><span class="va">field</span><span> </span><span class="st">&quot;post_id&quot;</span><span> </span><span class="va">uuid</span><span> </span><span class="sy">{</span><span> </span><span class="va">references</span><span> </span><span class="sy">=</span><span> </span><span class="cr">Just</span><span> </span><span class="st">&quot;posts&quot;</span><span class="sy">,</span><span> </span><span class="va">onDelete</span><span> </span><span class="sy">=</span><span> </span><span class="cr">Cascade</span><span> </span><span class="sy">}</span><span>
        </span><span class="op">+</span><span> </span><span class="va">field</span><span> </span><span class="st">&quot;author&quot;</span><span> </span><span class="va">text</span><span>
        </span><span class="op">+</span><span> </span><span class="va">field</span><span> </span><span class="st">&quot;body&quot;</span><span> </span><span class="va">text</span><span>
    </span><span class="sy">]</span><span>
</span></code></pre></div>
<h4 id="62-loading-the-schema">6.2 Loading the Schema</h4>
<p>Run <code>make dump_db</code> and <code>make db</code> to save our current posts to <code>Application/Fixtures.sql</code> and to rebuild the database to add our new <code>comments</code> table.</p>
<h4 id="63-the-controller">6.3 The Controller</h4>
<p>It’s time to also add a new controller for our comments. For that call the controller generator like this:</p>
<div class="source-code"><pre><code class="language-bash"><span>$ </span><span class="ex">new-controller</span><span> comments</span>
</code></pre></div>
<p>This will generate a new working controller for us. We now need to do some adjustments to better integrate the comments into the posts.</p>
<hr>
<p>Right now the comments are available at <code>/Comments</code>. As they are always connected to a post, we want to have them as a subresource of a post, e.g. like <code>/Posts/{postId}/Comments</code>.</p>
<p>Open <code>Web/Routes.hs</code> and change the <code>instance AutoRoute CommentsController</code> like this:</p>
<div class="source-code"><pre><code class="language-haskell"><span class="kw">instance</span><span> </span><span class="cr">AutoRoute</span><span> </span><span class="sy">(</span><span class="cr">PostsController</span><span> </span><span class="op">:&gt;</span><span> </span><span class="cr">CommentsController</span><span class="sy">)</span><span>
</span></code></pre></div>
<p>The <code>:&gt;</code> is a combinator to describe nested resource. In this case <code>PostsController</code> is the parent controller and <code>CommentsController</code> is the child controller.</p>
<hr>
<p>After this change, the dev server will show some errors like this:</p>
<div class="source-code"><pre><code class="language-haskell"><span class="cr">Web</span><span class="op">/</span><span class="cr">View</span><span class="op">/</span><span class="cr">Comments</span><span class="op">/</span><span class="va">Show.hs</span><span class="sy">:</span><span class="it">8</span><span class="sy">:</span><span class="it">33</span><span class="sy">:</span><span> </span><span class="va">error</span><span class="sy">:</span><span>
    </span><span class="op">•</span><span> </span><span class="cr">Could</span><span> </span><span class="va">not</span><span> </span><span class="va">deduce</span><span> </span><span class="sy">(</span><span class="cr">TurboHaskell.RouterSupport.AutoRoute</span><span> </span><span class="cr">CommentsController</span><span class="sy">)</span><span>
</span></code></pre></div>
<p>E.g. in the <code>Show.hs</code> the error is triggered by this line:</p>
<div class="source-code"><pre><code class="language-html"><span class="kw">&lt;li</span><span class="ot"> class=</span><span class="st">&quot;breadcrumb-item&quot;</span><span class="kw">&gt;&lt;a</span><span class="ot"> href=</span><span class="st">{CommentsAction}</span><span class="kw">&gt;</span><span>Comments</span><span class="kw">&lt;/a&gt;&lt;/li&gt;</span>
</code></pre></div>
<p>The <code>CommentsAction</code> (inside the <code>href</code>) is of type <code>CommentsController</code>. Because this controller is now a child controller of <code>PostsController</code>, we have to write <code>ShowPostAction { id = thePostId } :&gt; CommentsAction</code>. This expression is now of type <code>PostsController :&gt; CommentsController</code>.</p>
<p>Once fixed, the line needs to look like this:</p>
<div class="source-code"><pre><code class="language-html"><span class="kw">&lt;li</span><span class="ot"> class=</span><span class="st">&quot;breadcrumb-item&quot;</span><span class="kw">&gt;&lt;a</span><span class="ot"> href=</span><span class="st">{ShowPostAction</span><span> </span><span class="er">{</span><span class="ot"> id</span><span> </span><span class="ot">=</span><span> </span><span class="st">postId</span><span> </span><span class="er">}</span><span class="ot"> :</span><span class="kw">&gt;</span><span> CommentsAction}&gt;Comments</span><span class="kw">&lt;/a&gt;&lt;/li&gt;</span>
</code></pre></div>
<p>Of course now we also have to pass the <code>postId</code> to that view.</p>
<h3 id="form-customization">Form Customization</h3>
<h3 id="login-logout">Login &amp; Logout</h3>
<h1 id="querybuilder-reference">QueryBuilder Reference</h1>
<p>You can compose database queries using the QueryBuilder module.</p>
<h2 id="creating-a-new-query">Creating a new query</h2>
<p>To query the database for some records, you first need to build a query.
You can just use the <code>query</code> function for that.</p>
<div class="source-code"><pre><code class="language-haskell"><span class="kw">let</span><span> </span><span class="va">myQueryBuilder</span><span> </span><span class="sy">=</span><span> </span><span class="va">query</span><span>
</span></code></pre></div>
<p>You can optionally specify the model you want to query:</p>
<div class="source-code"><pre><code class="language-haskell"><span class="kw">let</span><span> </span><span class="va">myProjectQueryBuilder</span><span> </span><span class="sy">=</span><span> </span><span class="va">query</span><span> </span><span class="sy">@</span><span class="cr">Project</span><span>
</span></code></pre></div>
<h2 id="running-a-query">Running a query</h2>
<p>You can run a query using <code>fetch</code>, <code>fetchOneOrNothing</code> or <code>fetchOne</code>:</p>
<h3 id="many-rows-fetch">many rows: <code>fetch</code></h3>
<p>To run a query which will return many rows use <code>fetch</code>:</p>
<div class="source-code"><pre><code class="language-haskell"><span class="va">example</span><span> </span><span class="sy">::</span><span> </span><span class="cr">IO</span><span> </span><span class="sy">[</span><span class="cr">Project</span><span class="sy">]</span><span>
</span><span class="va">example</span><span> </span><span class="sy">=</span><span> </span><span class="kw">do</span><span>
    </span><span class="va">projects</span><span> </span><span class="sy">&lt;-</span><span> </span><span class="va">query</span><span> </span><span class="sy">@</span><span class="cr">Project</span><span> </span><span class="op">|&gt;</span><span> </span><span class="va">fetch</span><span>
    </span><span class="co">-- Query: `SELECT * FROM projects`</span><span>
    </span><span class="va">return</span><span> </span><span class="va">projects</span><span>
</span></code></pre></div>
<h3 id="maybe-single-row-fetchoneornothing">maybe single row: <code>fetchOneOrNothing</code></h3>
<p>To run a query which will maybe return a single row use <code>fetchOneOrNothing</code>:</p>
<div class="source-code"><pre><code class="language-haskell"><span class="va">example</span><span> </span><span class="sy">::</span><span> </span><span class="cr">IO</span><span> </span><span class="sy">(</span><span class="cr">Maybe</span><span> </span><span class="cr">Project</span><span class="sy">)</span><span>
</span><span class="va">example</span><span> </span><span class="sy">=</span><span> </span><span class="kw">do</span><span>
    </span><span class="va">project</span><span> </span><span class="sy">&lt;-</span><span> </span><span class="va">query</span><span> </span><span class="sy">@</span><span class="cr">Project</span><span> </span><span class="op">|&gt;</span><span> </span><span class="va">fetchOneOrNothing</span><span>
    </span><span class="co">-- Query: `SELECT * FROM projects LIMIT 1`</span><span>
    </span><span class="va">return</span><span> </span><span class="va">project</span><span>
</span></code></pre></div>
<h3 id="single-row-fetchone">single row: <code>fetchOne</code></h3>
<p>To run a query which will return a single and <strong>throws an error if no record is found</strong> row use <code>fetchOne</code>:</p>
<div class="source-code"><pre><code class="language-haskell"><span class="va">example</span><span> </span><span class="sy">::</span><span> </span><span class="cr">IO</span><span> </span><span class="cr">Project</span><span>
</span><span class="va">example</span><span> </span><span class="sy">=</span><span> </span><span class="kw">do</span><span>
    </span><span class="va">project</span><span> </span><span class="sy">&lt;-</span><span> </span><span class="va">query</span><span> </span><span class="sy">@</span><span class="cr">Project</span><span> </span><span class="op">|&gt;</span><span> </span><span class="va">fetchOne</span><span>
    </span><span class="co">-- Query: `SELECT * FROM projects LIMIT 1`</span><span>
    </span><span class="va">return</span><span> </span><span class="va">project</span><span>
</span></code></pre></div>
<h2 id="where-conditions">Where Conditions</h2>
<p>To specify <code>WHERE</code> conditions, you can use <code>filterWhere</code>:</p>
<div class="source-code"><pre><code class="language-haskell"><span class="va">projectsByUser</span><span> </span><span class="sy">::</span><span> </span><span class="cr">UserId</span><span> </span><span class="sy">-&gt;</span><span> </span><span class="cr">IO</span><span> </span><span class="sy">[</span><span class="cr">Project</span><span class="sy">]</span><span>
</span><span class="va">projectsByUser</span><span> </span><span class="va">userId</span><span> </span><span class="sy">=</span><span> </span><span class="kw">do</span><span>
    </span><span class="va">projects</span><span> </span><span class="sy">&lt;-</span><span> </span><span class="va">query</span><span> </span><span class="sy">@</span><span class="cr">Project</span><span>
            </span><span class="op">|&gt;</span><span> </span><span class="va">filterWhere</span><span> </span><span class="sy">(#</span><span class="va">userId</span><span class="sy">,</span><span> </span><span class="va">userId</span><span class="sy">)</span><span>
            </span><span class="op">|&gt;</span><span> </span><span class="va">filterWhere</span><span> </span><span class="sy">(#</span><span class="va">deleted</span><span class="sy">,</span><span> </span><span class="cr">False</span><span class="sy">)</span><span>
            </span><span class="op">|&gt;</span><span> </span><span class="va">fetch</span><span>
    </span><span class="co">-- Query: `SELECT * FROM projects WHERE user_id = &lt;userId&gt; AND deleted = false`</span><span>
    </span><span class="va">return</span><span> </span><span class="va">projects</span><span>
</span></code></pre></div>
<h2 id="order-by">Order By</h2>
<p>You can just use <code>orderBy #field</code>:</p>
<div class="source-code"><pre><code class="language-haskell"><span class="va">projects</span><span> </span><span class="sy">&lt;-</span><span> </span><span class="va">query</span><span> </span><span class="sy">@</span><span class="cr">Project</span><span>
        </span><span class="op">|&gt;</span><span> </span><span class="va">orderBy</span><span> </span><span class="va">#createdAt</span><span>
        </span><span class="op">|&gt;</span><span> </span><span class="va">fetch</span><span>
</span><span class="co">-- Query: `SELECT * FROM projects ORDER BY created_at`</span><span>
</span></code></pre></div>
<h2 id="or">Or</h2>
<div class="source-code"><pre><code class="language-haskell"><span class="va">projects</span><span> </span><span class="sy">&lt;-</span><span> </span><span class="va">query</span><span> </span><span class="sy">@</span><span class="cr">Project</span><span>
         </span><span class="op">|&gt;</span><span> </span><span class="va">queryOr</span><span>
            </span><span class="sy">(</span><span class="va">filterWhere</span><span> </span><span class="sy">(#</span><span class="va">userId</span><span class="sy">,</span><span> </span><span class="va">userId</span><span class="sy">)</span><span class="sy">)</span><span> </span><span class="sy">(</span><span class="va">filterWhere</span><span> </span><span class="sy">(#</span><span class="va">teamId</span><span class="sy">,</span><span> </span><span class="va">teamId</span><span class="sy">)</span><span class="sy">)</span><span>
        </span><span class="op">|&gt;</span><span> </span><span class="va">fetch</span><span>
</span><span class="co">-- Query: `SELECT * FROM projects WHERE (user_id = ?) OR (team_id = ?)`</span><span>
</span></code></pre></div>
<h2 id="union-merging-two-queries">Union / Merging two queries</h2>
<p>Two query builders of the same type can be merged like this:</p>
<div class="source-code"><pre><code class="language-haskell"><span class="co">-- SELECT * FROM projects WHERE team_id = ?</span><span>
</span><span class="kw">let</span><span> </span><span class="va">teamProjects</span><span> </span><span class="sy">::</span><span> </span><span class="cr">QueryBuilder</span><span> </span><span class="cr">Project</span><span> </span><span class="sy">=</span><span> </span><span class="va">query</span><span> </span><span class="sy">@</span><span class="cr">Project</span><span> </span><span class="op">|&gt;</span><span> </span><span class="va">filterWhere</span><span> </span><span class="sy">(#</span><span class="va">teamId</span><span class="sy">,</span><span> </span><span class="va">teamId</span><span class="sy">)</span><span>

</span><span class="co">-- SELECT * FROM projects WHERE team_id IS NULL AND created_by = ?</span><span>
</span><span class="kw">let</span><span> </span><span class="va">personalProjects</span><span> </span><span class="sy">::</span><span> </span><span class="cr">QueryBuilder</span><span> </span><span class="cr">Project</span><span> </span><span class="sy">=</span><span> </span><span class="va">query</span><span> </span><span class="sy">@</span><span class="cr">Project</span><span> </span><span class="op">|&gt;</span><span> </span><span class="va">filterWhere</span><span> </span><span class="sy">(#</span><span class="va">teamId</span><span class="sy">,</span><span> </span><span class="cr">Nothing</span><span class="sy">)</span><span> </span><span class="op">|&gt;</span><span> </span><span class="va">filterWhere</span><span> </span><span class="sy">(#</span><span class="va">createdBy</span><span class="sy">,</span><span> </span><span class="va">currentUserId</span><span class="sy">)</span><span>

</span><span class="co">-- SELECT * FROM projects WHERE (team_id = ?) OR (team_id IS NULL AND created_by = ?)</span><span>
</span><span class="kw">let</span><span> </span><span class="va">projects</span><span> </span><span class="sy">::</span><span> </span><span class="cr">QueryBuilder</span><span> </span><span class="cr">Project</span><span> </span><span class="sy">=</span><span> </span><span class="va">queryUnion</span><span> </span><span class="va">teamProjects</span><span> </span><span class="va">personalProjects</span><span>
</span></code></pre></div>
<h2 id="shortcuts">Shortcuts</h2>
<h3 id="findby-field-value"><code>findBy #field value</code></h3>
<p>Just a shortcut for <code>filterWhere (#field, value) |&gt; fetchOne</code></p>
<div class="source-code"><pre><code class="language-haskell"><span class="co">-- Long version</span><span>
</span><span class="va">project</span><span> </span><span class="sy">&lt;-</span><span> </span><span class="va">query</span><span> </span><span class="sy">@</span><span class="cr">Project</span><span> </span><span class="op">|&gt;</span><span> </span><span class="va">filterWhere</span><span> </span><span class="sy">(#</span><span class="va">userId</span><span class="sy">,</span><span> </span><span class="va">userId</span><span class="sy">)</span><span> </span><span class="op">|&gt;</span><span> </span><span class="va">fetchOne</span><span>
</span><span class="co">-- Shorter version</span><span>
</span><span class="va">project</span><span> </span><span class="sy">&lt;-</span><span> </span><span class="va">query</span><span> </span><span class="sy">@</span><span class="cr">Project</span><span> </span><span class="op">|&gt;</span><span> </span><span class="va">findBy</span><span> </span><span class="va">#userId</span><span> </span><span class="va">userId</span><span>
</span></code></pre></div>
<h3 id="findmaybeby-field-value"><code>findMaybeBy #field value</code></h3>
<p>Just a shortcut for <code>filterWhere (#field, value) |&gt; fetchOneOrNothing</code></p>
<div class="source-code"><pre><code class="language-haskell"><span class="co">-- Long version</span><span>
</span><span class="va">project</span><span> </span><span class="sy">&lt;-</span><span> </span><span class="va">query</span><span> </span><span class="sy">@</span><span class="cr">Project</span><span> </span><span class="op">|&gt;</span><span> </span><span class="va">filterWhere</span><span> </span><span class="sy">(#</span><span class="va">userId</span><span class="sy">,</span><span> </span><span class="va">userId</span><span class="sy">)</span><span> </span><span class="op">|&gt;</span><span> </span><span class="va">fetchOneOrNothing</span><span>
</span><span class="co">-- Shorter version</span><span>
</span><span class="va">project</span><span> </span><span class="sy">&lt;-</span><span> </span><span class="va">query</span><span> </span><span class="sy">@</span><span class="cr">Project</span><span> </span><span class="op">|&gt;</span><span> </span><span class="va">findMaybeBy</span><span> </span><span class="va">#userId</span><span> </span><span class="va">userId</span><span>
</span></code></pre></div>
<h3 id="findbyid-id"><code>findById id</code></h3>
<p>Just a shortcut for <code>filterWhere (#id, id) |&gt; fetchOne</code></p>
<div class="source-code"><pre><code class="language-haskell"><span class="co">-- Long version</span><span>
</span><span class="va">project</span><span> </span><span class="sy">&lt;-</span><span> </span><span class="va">query</span><span> </span><span class="sy">@</span><span class="cr">Project</span><span> </span><span class="op">|&gt;</span><span> </span><span class="va">filterWhere</span><span> </span><span class="sy">(#</span><span class="va">id</span><span class="sy">,</span><span> </span><span class="va">id</span><span class="sy">)</span><span> </span><span class="op">|&gt;</span><span> </span><span class="va">fetchOne</span><span>
</span><span class="co">-- Shorter version</span><span>
</span><span class="va">project</span><span> </span><span class="sy">&lt;-</span><span> </span><span class="va">query</span><span> </span><span class="sy">@</span><span class="cr">Project</span><span> </span><span class="op">|&gt;</span><span> </span><span class="va">findOneById</span><span> </span><span class="va">#id</span><span> </span><span class="va">id</span><span>
</span></code></pre></div>
<h3 id="findmanyby-field-value"><code>findManyBy #field value</code></h3>
<p>Just a shortcut for <code>filterWhere (#field, value) |&gt; fetch</code></p>
<div class="source-code"><pre><code class="language-haskell"><span class="co">-- Long version</span><span>
</span><span class="va">projects</span><span> </span><span class="sy">&lt;-</span><span> </span><span class="va">query</span><span> </span><span class="sy">@</span><span class="cr">Project</span><span> </span><span class="op">|&gt;</span><span> </span><span class="va">filterWhere</span><span> </span><span class="sy">(#</span><span class="va">userId</span><span class="sy">,</span><span> </span><span class="va">userId</span><span class="sy">)</span><span> </span><span class="op">|&gt;</span><span> </span><span class="va">fetch</span><span>
</span><span class="co">-- Shorter version</span><span>
</span><span class="va">projects</span><span> </span><span class="sy">&lt;-</span><span> </span><span class="va">query</span><span> </span><span class="sy">@</span><span class="cr">Project</span><span> </span><span class="op">|&gt;</span><span> </span><span class="va">findManyBy</span><span> </span><span class="va">#userId</span><span> </span><span class="va">userId</span><span>
</span></code></pre></div>
<h2 id="projectid-fetch"><code>projectId |&gt; fetch</code></h2>
<p>Ids also have <code>fetch</code> implementations, that way you can just run:</p>
<div class="source-code"><pre><code class="language-haskell"><span class="kw">let</span><span> </span><span class="va">projectId</span><span> </span><span class="sy">::</span><span> </span><span class="cr">ProjectId</span><span> </span><span class="sy">=</span><span> </span><span class="op">...</span><span>
</span><span class="va">project</span><span> </span><span class="sy">&lt;-</span><span> </span><span class="va">projectId</span><span> </span><span class="op">|&gt;</span><span> </span><span class="va">fetch</span><span>
</span></code></pre></div>
<p>For convience there is also a <code>fetch</code> implementation for <code>Maybe SomeId</code>:</p>
<div class="source-code"><pre><code class="language-haskell"><span class="kw">let</span><span> </span><span class="va">assignedUserId</span><span> </span><span class="sy">::</span><span> </span><span class="cr">Maybe</span><span> </span><span class="cr">UserId</span><span> </span><span class="sy">=</span><span> </span><span class="va">project</span><span> </span><span class="op">|&gt;</span><span> </span><span class="va">get</span><span> </span><span class="va">#assignedUserId</span><span>
</span><span class="va">assignedUser</span><span> </span><span class="sy">&lt;-</span><span> </span><span class="va">assignedUserId</span><span> </span><span class="op">|&gt;</span><span> </span><span class="va">fetchOneOrNothing</span><span>
</span></code></pre></div>
<h2 id="raw-sql-queries">Raw SQL Queries</h2>
<div class="source-code"><pre><code class="language-haskell"><span class="va">result</span><span> </span><span class="sy">&lt;-</span><span> </span><span class="va">sqlQuery</span><span> </span><span class="st">&quot;SELECT * FROM projects WHERE id = ?&quot;</span><span> </span><span class="sy">(</span><span class="cr">Only</span><span> </span><span class="va">id</span><span class="sy">)</span><span>
</span></code></pre></div>
<h1 id="validation-reference">Validation Reference</h1>
<h2 id="pure-validations">Pure Validations</h2>
<p>With <code>validateField</code> you can do simple, pure validations.</p>
<p>Here are some examples:</p>
<div class="source-code"><pre><code class="language-haskell"><span class="kw">instance</span><span> </span><span class="cr">ValidateRecord</span><span> </span><span class="cr">NewPost</span><span> </span><span class="cr">ControllerContext</span><span> </span><span class="kw">where</span><span>
    </span><span class="va">validateRecord</span><span> </span><span class="sy">=</span><span> </span><span class="kw">do</span><span>
        </span><span class="va">validateField</span><span> </span><span class="va">#title</span><span> </span><span class="va">nonEmpty</span><span>
        </span><span class="va">validateField</span><span> </span><span class="va">#phone</span><span> </span><span class="va">isPhoneNumber</span><span>
        </span><span class="va">validateField</span><span> </span><span class="va">#email</span><span> </span><span class="va">isEmail</span><span>
        </span><span class="kw">let</span><span> </span><span class="va">isAge</span><span> </span><span class="sy">=</span><span> </span><span class="va">isInRange</span><span> </span><span class="sy">(</span><span class="it">0</span><span class="sy">,</span><span> </span><span class="it">100</span><span class="sy">)</span><span> </span><span class="kw">in</span><span> </span><span class="va">validateField</span><span> </span><span class="va">#age</span><span> </span><span class="va">isAge</span><span>
</span></code></pre></div>
<h3 id="custom-validators">Custom Validators</h3>
<p>If needed you can just write your own constraint, e.g. like this:</p>
<div class="source-code"><pre><code class="language-haskell"><span class="va">nonEmpty</span><span> </span><span class="sy">::</span><span> </span><span class="cr">Text</span><span> </span><span class="sy">-&gt;</span><span> </span><span class="cr">ValidatorResult</span><span>
</span><span class="va">nonEmpty</span><span> </span><span class="st">&quot;&quot;</span><span> </span><span class="sy">=</span><span> </span><span class="cr">Failure</span><span> </span><span class="st">&quot;This field cannot be empty&quot;</span><span>
</span><span class="va">nonEmpty</span><span> </span><span class="sy">_</span><span> </span><span class="sy">=</span><span> </span><span class="cr">Success</span><span>

</span><span class="va">isAge</span><span> </span><span class="sy">::</span><span> </span><span class="cr">Int</span><span> </span><span class="sy">-&gt;</span><span> </span><span class="cr">ValidatorResult</span><span>
</span><span class="va">isAge</span><span> </span><span class="sy">=</span><span> </span><span class="va">isInRange</span><span> </span><span class="sy">(</span><span class="it">0</span><span class="sy">,</span><span> </span><span class="it">100</span><span class="sy">)</span><span>
</span></code></pre></div>
<h2 id="uniqueness">Uniqueness</h2>
<p>The function <code>validateIsUnique</code> is usually used to make sure that e.g. a user’s email is unique. Of course it will also work with other model fields.</p>
<div class="source-code"><pre><code class="language-haskell"><span class="kw">instance</span><span> </span><span class="cr">ValidateRecord</span><span> </span><span class="cr">NewPost</span><span> </span><span class="cr">ControllerContext</span><span> </span><span class="kw">where</span><span>
    </span><span class="va">validateRecord</span><span> </span><span class="sy">=</span><span> </span><span class="kw">do</span><span>
        </span><span class="va">validateIsUnique</span><span> </span><span class="va">#email</span><span>
</span></code></pre></div>
<h2 id="validate-permissions">Validate Permissions</h2>
<div class="source-code"><pre><code class="language-haskell"><span class="kw">instance</span><span> </span><span class="cr">ValidateRecord</span><span> </span><span class="cr">NewPost</span><span> </span><span class="cr">ControllerContext</span><span> </span><span class="kw">where</span><span>
    </span><span class="va">validateRecord</span><span> </span><span class="sy">=</span><span> </span><span class="kw">do</span><span>
        </span><span class="va">validateCanView</span><span> </span><span class="va">currentUser</span><span>
</span></code></pre></div>
<h1 id="view-helper-reference">View Helper Reference</h1>
<h2 id="time">Time</h2>
<h3 id="timeago"><code>timeAgo</code></h3>
<div class="source-code"><pre><code class="language-haskell"><span class="va">timeAgo</span><span> </span><span class="sy">(</span><span class="va">get</span><span> </span><span class="va">#createdAt</span><span> </span><span class="va">post</span><span class="sy">)</span><span> </span><span class="co">-- &quot;1 minute ago&quot;</span><span>
</span></code></pre></div>
<h3 id="datetime"><code>dateTime</code></h3>
<div class="source-code"><pre><code class="language-haskell"><span class="va">dateTime</span><span> </span><span class="sy">(</span><span class="va">get</span><span> </span><span class="va">#createdAt</span><span> </span><span class="va">post</span><span class="sy">)</span><span> </span><span class="co">-- &quot;10.6.2019, 15:58 Uhr&quot;</span><span>
</span></code></pre></div>
<h1 id="command-line-reference">Command Line Reference</h1>
<table>
<thead>
<tr><th>Command</th><th>Description</th></tr>
</thead>
<tbody>
<tr><td>make</td><td>Starts the dev server</td></tr>
<tr><td>make db</td><td>Creates a new database with the current Schema and imports Fixtures.sql</td></tr>
<tr><td>make dumpdb</td><td>Saves the current database state into the Fixtures.sql</td></tr>
<tr><td>make psql</td><td>Connects to the running postgresql server</td></tr>
<tr><td>ghci</td><td>Opens a new ghci session with the project and framework already loaded</td></tr>
<tr><td>make clean</td><td>Resets all build and temporary files</td></tr>
<tr><td>make print-ghc-extensions</td><td>Prints all used ghc extensions. Useful for scripting</td></tr>
<tr><td>make print-ghc-options</td><td>Prints all used ghc options. Useful for scripting</td></tr>
<tr><td>make build/bin/RunUnoptimizedProdServer</td><td>Quickly does a production build (all compiler optimizations disabled)</td></tr>
<tr><td>make build/bin/RunOptimizedProdServer</td><td>Full production build with all ghc optimizations (takes a while)</td></tr>
<tr><td>make static/prod.js</td><td>Builds the production js bundle</td></tr>
<tr><td>make static/prod.css</td><td>Builds the production css bundle</td></tr>
</tbody>
</table>
<h1 id="form-reference">Form Reference</h1>
<h2 id="select-inputs">Select Inputs</h2>
<p>You can use the <code>selectField</code> helper for select inputs:</p>
<div class="source-code"><pre><code class="language-haskell"><span class="va">formFor</span><span> </span><span class="va">project</span><span> </span><span class="sy">[hsx|
    {selectField #userId users}
|]</span><span>
</span></code></pre></div>
<p>In the example above the variable <code>users</code> contains all the possible option values for the select.</p>
<p>You also need to define a instance <code>CanSelect User</code>:</p>
<div class="source-code"><pre><code class="language-haskell"><span class="kw">instance</span><span> </span><span class="cr">CanSelect</span><span> </span><span class="cr">User</span><span> </span><span class="kw">where</span><span>
    </span><span class="co">-- Here we specify that the &lt;option&gt;-value should contain a UserId</span><span>
    </span><span class="kw">type</span><span> </span><span class="cr">SelectValue</span><span> </span><span class="cr">User</span><span> </span><span class="sy">=</span><span> </span><span class="cr">UserId</span><span>
    </span><span class="co">-- Here we specify how to transform the model into &lt;option&gt;-value</span><span>
    </span><span class="va">selectValue</span><span> </span><span class="sy">=</span><span> </span><span class="va">get</span><span> </span><span class="va">#id</span><span>
    </span><span class="co">-- And here we specify the &lt;option&gt;-text</span><span>
    </span><span class="va">selectLabel</span><span> </span><span class="sy">=</span><span> </span><span class="va">get</span><span> </span><span class="va">#name</span><span>
</span></code></pre></div>
<p>Given the above example, the rendered form will look like this:</p>
<div class="source-code"><pre><code class="language-html"><span>-- Assuming: users = [User { id = 1, name = &quot;Marc&quot; }, User { id = 2, name = &quot;Andreas&quot; }]</span>
<span class="kw">&lt;form</span><span> </span><span class="er">...</span><span class="kw">&gt;</span>
<span>    </span><span class="kw">&lt;select</span><span class="ot"> name=</span><span class="st">&quot;user_id&quot;</span><span class="kw">&gt;</span>
<span>        </span><span class="kw">&lt;option</span><span class="ot"> value=</span><span class="st">&quot;1&quot;</span><span class="kw">&gt;</span><span>Marc</span><span class="kw">&lt;/option&gt;</span>
<span>        </span><span class="kw">&lt;option</span><span class="ot"> value=</span><span class="st">&quot;2&quot;</span><span class="kw">&gt;</span><span>Andreas</span><span class="kw">&lt;/option&gt;</span>
<span>    </span><span class="kw">&lt;/select&gt;</span>
<span class="kw">&lt;/form&gt;</span>
</code></pre></div>
<h1 id="debuging">Debuging</h1>
<p>TODO: Show example using traceShowId</p>
<h1 id="architecture">Architecture</h1>
<p>This section tries to answer common questions on where to place your code.</p>
<p>In general remember that all specific web app logic should stay in the <code>Web/</code> space. The <code>Application/</code> space is for sharing code across all your different application. E.g. code shared between your web application and your admin backend.</p>
<h5 id="where-to-place-a-function-i-want-to-use-in-all-my-views">Where to place a function I want to use in all my views?</h5>
<p>If the function is only used in a single application and is a building block for your layout, place it in <code>Web/View/Layout.hs</code>. The module is already imported in all your views (just don’t forget to add the function to the export list).</p>
<p>If the function is used across multiple applications or more like a helper function, place it in <code>Application/Helper/View.hs</code>. This module is also already included in your view files.</p>
<h5 id="where-to-place-a-function-i-want-to-use-in-all-my-controllers">Where to place a function I want to use in all my controllers?</h5>
<p>Place it in <code>Application/Helper/Controller.hs</code>. This module is already imported into your controllers.</p>
<h5 id="where-to-place-a-custom-type">Where to place a custom type?</h5>
<p>Place it in <code>Web/Types.hs</code>.</p>
<h5 id="next-to-my-main-web-application-im-building-an-admin-backend-application-where-to-place-it">Next to my main web application, I’m building an admin backend application. Where to place it?</h5>
<p>A TurboHaskell project can consist of multiple applications. Run <code>new-application admin</code> to generate a new admin application. The logic for the new application is located in the <code>Admin/</code> directory. On the web you can find it at <code>http://localhost:8000/admin/</code> (all actions are prefixed with <code>/admin/</code>).</p>
</div>

    

    <style>
      .source-code {
        background-color: #002b36;
        
        border-radius: 3px;
      }
      .language-haskell, .language-bash, .language-sql, .language-html, .language-nix {
        color: #839496;
        display: block;
        padding: 1rem;
      }

      code {
        background-color: rgba(0, 43, 54, 0.11);
        color: #002b36;
      }

      code .cr {
        color: #93a1a1
        font-weight: bold;
      }

      code.language-haskell .kw, code.language-sql .kw, code.language-html .kw { color: #859900; }
      code.language-haskell .st { color: #2aa198; }

      pre { overflow: scroll; }

      img { width: 100%; }
    </style>

    <script>
        var tables = document.querySelectorAll('table');
        for (let table of tables) {
          table.classList.add('table');
        }
    </script>
  </body>
</html>