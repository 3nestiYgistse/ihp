#!/bin/bash -e
DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" >/dev/null 2>&1 && pwd )"

# Ensure we are in an app dir
if [ ! -f App.hs ]; then
    echo "You have to be in a app dir (e.g. src/Apps/Web) to run the generator"
	exit 1
fi

# Switch to project root
cd ..


FRAMEWORKDIR=$(dirname $(readlink $(which RunDevServer)))/../
if [ -d TurboHaskell ]; then
	FRAMEWORKDIR="$(pwd)/TurboHaskell"
fi

GHCI_SCRIPT="$(mktemp)"

echo ":script $FRAMEWORKDIR/applicationGhciConfig" > "$GHCI_SCRIPT"
echo "import TurboHaskell.ControllerGenerator" >> "$GHCI_SCRIPT"
echo ":l Application/Schema.hs" >> "$GHCI_SCRIPT"
echo "main' database [\"$@\"]" >> "$GHCI_SCRIPT"
echo ":quit" >> "$GHCI_SCRIPT"

ghci -threaded -i. -iTurboHaskell -fomit-interface-pragmas +RTS -A128m -RTS < "$GHCI_SCRIPT"

rm "$GHCI_SCRIPT"