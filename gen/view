#!/usr/bin/env php
<?php
$basePath = realpath(__DIR__ . "../../..");
$controller = ucfirst($argv[1]);
$action = $argv[2];

if ($argc < 3) {
    echo "Usage: gen/view CONTROLLER_NAME ACTION_NAME\n";
    exit(1);
}

$isMailer = strpos($controller, 'Mailer') > 0;

$controllerPath = ltrim("$basePath/src/Controller/$controller.hs", '/');
if (!file_exists($controllerPath) && $controller !== 'Layout' && !$isMailer) {
    echo "Controller not found: $controllerPath\n";
    exit(1);
}

$viewDirectory = ltrim("$basePath/src/View/$controller", '/');
$viewPath = ltrim("$basePath/src/View/$controller/" . ucfirst($action) . ".hs", '/');
if (file_exists($viewPath)) {
    echo "View already exists: $viewPath\n";
    exit(1);
}

$model = str_replace('Mailer', '', $controller);
if ($model[strlen($model) - 1] === "s") {
    $model = substr($model, 0, strlen($model) - 1);
}
$modelVariable = lcfirst($model);

ob_start();
?>
module View.<?= $controller ?>.<?= ucfirst($action) ?> (render) where
<?php if (!$isMailer) { ?>
import Foundation.ViewPrelude
import qualified View.Layout.Default

<?php if (strtolower($action) === 'new') { ?>
render :: New<?php echo $model; ?> -> Html
render <?php echo $modelVariable; ?> = View.Layout.Default.html [hsx|
<nav>
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href={<?= lcfirst($model) ?>sPath}><?php echo $controller; ?></a></li>
        <li class="breadcrumb-item active">New <?= $controller ?></li>
    </ol>
</nav>
<h1>New <?php echo $controller; ?></h1>
{renderForm <?php echo $modelVariable; ?>}
|]

renderForm :: New<?php echo $model; ?> -> Html
renderForm <?php echo $modelVariable; ?> = formFor <?php echo $modelVariable; ?> <?php echo $modelVariable; ?>sPath [hsx|
{submitButton}
|]

<?php } elseif (strtolower($action) === 'edit') { ?>
render :: <?php echo $model; ?> -> Html
render <?php echo $modelVariable; ?> = View.Layout.Default.html [hsx|
<nav>
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href={<?= lcfirst($model) ?>sPath}><?php echo $controller; ?></a></li>
        <li class="breadcrumb-item active">Edit <?= $controller ?></li>
    </ol>
</nav>
<h1>Edit <?php echo $controller; ?></h1>
{renderForm <?php echo $modelVariable; ?>}
|]

renderForm :: <?php echo $model; ?> -> Html
renderForm <?php echo $modelVariable; ?> = formFor <?php echo $modelVariable; ?> (<?php echo $modelVariable; ?>Path <?= $modelVariable ?>) [hsx|
{submitButton}
|]

<?php } elseif (strtolower($action) === 'index') { ?>
render :: [<?php echo $model; ?>] -> Html
render <?php echo $modelVariable; ?>s = View.Layout.Default.html [hsx|
<h1>
    <?= $controller ?>

    <a href={new<?= $model ?>Path} class="btn btn-link ml-2">+ New <?= $model ?></a>
</h1>

<table class="table">
    <thead>
        <tr>
            <th><?= $model ?></th>
            <th></th>
            <th></th>
            <th></th>
        </tr>
    </thead>
    <tbody>{forM_ <?= lcfirst($model) ?>s render<?= $model ?>}</tbody>
</table>
|]

render<?= $model ?> <?= lcfirst($model) ?> = [hsx|
<tr>
    <td>{<?= lcfirst($model) ?>}</td>
    <td><a href={<?= lcfirst($model) ?>Path <?= lcfirst($model) ?>}>Show</a></td>
    <td><a href={edit<?= $model ?>Path <?= lcfirst($model) ?>}>Edit</a></td>
    <td><a href={<?= lcfirst($model) ?>Path <?= lcfirst($model) ?>} class="js-delete text-danger">Destroy</a></td>
</tr>
|]
<?php } else { ?>
render :: <?php echo $model; ?> -> Html
render <?php echo $modelVariable; ?> = View.Layout.Default.html [hsx|
    <p>"Hello World from View.<?= $controller ?>.<?= ucfirst($action) ?>"</p>
|]
<?php } ?>
<?php } else { ?>
import           Foundation.MailerPrelude

render :: <?php echo $model; ?> -> Mail
render <?php echo $modelVariable; ?> = simpleMail' to from subject plainBody
    where
        to = Address (pure "Marc Scholten") "marc@digitallyinduced.com"
        from = Address (pure "Callback Tool") "callbacktool@digitallyinduced.com"
        subject = "Welcome to Callback Tool!"
        plainBody = cs $ renderPlainText <?php echo $modelVariable . "\n"; ?>
        htmlBody = ""
        attachments = []

renderPlainText <?php echo $modelVariable; ?> = [plain|
|]
<?php } ?>

<?php
$body = ob_get_clean();

if (!file_exists($viewDirectory)) {
    echo "+ $viewDirectory\n";
    mkdir($viewDirectory);
}

file_put_contents($viewPath, $body);
echo "+ $viewPath\n";

if (file_exists($controllerPath)) {
    $content = file_get_contents($controllerPath);
    $lines = explode("\n", $content);
    $importLine = "import qualified View.$controller." . ucfirst($action) . " as " . ucfirst($action);
    array_splice($lines, 2, 0, [$importLine]);
    $newContent = implode("\n", $lines);
    file_put_contents($controllerPath, $newContent);
    echo "* $controllerPath\n";
}
